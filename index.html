<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oto YÄ±kama Takip Sistemi</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Genel SÄ±fÄ±rlama ve Body Stili */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* Ana Konteyner */
        .container {
            max-width: 1200px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border-radius: 25px;
            padding: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }

        /* BaÅŸlÄ±k Stili */
        .header {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        /* Buton Stili */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }


        /* Ekran YÃ¶netimi */
        .screen {
            display: none;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Ã–ÄŸeleri */
        .form-group {
            margin-bottom: 20px;
            position: relative; /* For error messages */
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background-color: #fcfcfc;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }
        input.is-invalid, select.is-invalid, textarea.is-invalid {
            border-color: #e74c3c;
            box-shadow: 0 0 0 4px rgba(231, 76, 60, 0.2);
        }
        .error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            position: absolute;
            bottom: -18px; /* Position below input */
            left: 0;
        }


        /* Arama Ã‡ubuÄŸu */
        .search-container {
            position: relative;
            margin-bottom: 30px;
        }

        .search-input {
            padding-left: 50px;
            font-size: 18px;
            height: 60px;
            border-radius: 30px;
            background-color: #f0f0f0;
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            color: #667eea;
        }

        /* AraÃ§ KartÄ± GÃ¶sterimi */
        .car-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #e0e6f0 100%);
            border-radius: 18px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }

        .car-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .car-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .plate-number {
            font-size: 26px;
            font-weight: bold;
            color: #4a5ee5;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
        }

        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Yeni Durum Renkleri */
        .status.inqueue {
            background: #bdbdbd; /* Gri */
            color: #424242;
        }
        .status.exteriorwash {
            background: #ffd54f; /* Hafif sarÄ± */
            color: #f57f17;
        }
        .status.dryingarea {
            background: #a5d6a7; /* Hafif yeÅŸil */
            color: #2e7d32;
        }
        .status.parkingarea {
            background: #90caf9; /* Hafif mavi */
            color: #1976d2;
        }
        .status.delivered {
            background: #b0bec5; /* Mavi gri */
            color: #455a64;
        }

        /* AÃ§Ä±lÄ±r KapanÄ±r Detaylar */
        .car-card details {
            margin-top: 15px;
            border-top: 1px solid rgba(0,0,0,0.1);
            padding-top: 15px;
        }

        .car-card summary {
            font-weight: bold;
            cursor: pointer;
            color: #667eea;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
        }

        .car-card summary::before {
            content: "\f054"; /* Font Awesome saÄŸ ok */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            margin-right: 5px;
            transition: transform 0.2s ease;
        }

        .car-card details[open] summary::before {
            transform: rotate(90deg); /* AÃ§Ä±kken oku dÃ¶ndÃ¼r */
        }

        .car-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
            margin-top: 15px;
        }

        .detail-item {
            background: rgba(255, 255, 255, 0.85);
            padding: 12px;
            border-radius: 10px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .detail-label {
            font-size: 13px;
            color: #777;
            margin-bottom: 5px;
        }

        .detail-value {
            font-weight: bold;
            color: #333;
            word-break: break-word;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 10px;
            margin: 15px 0;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Memnuniyet Anketi */
        .satisfaction-survey {
            background: linear-gradient(135deg, #fff0da 0%, #ffdfc0 100%);
            border-radius: 18px;
            padding: 30px;
            margin-top: 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .satisfaction-survey h3 {
            color: #d17a22;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .satisfaction-survey p {
            color: #6a4a2a;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .rating-stars {
            display: flex;
            gap: 12px;
            margin: 15px 0 25px;
            justify-content: center;
        }

        .star {
            font-size: 36px;
            color: #c7c7c7;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .star.active, .star:hover {
            color: #ffc107;
            transform: scale(1.1);
        }

        /* Raporlar BÃ¶lÃ¼mÃ¼ */
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .report-card {
            background: linear-gradient(135deg, #e6f7f7 0%, #d8eafa 100%);
            border-radius: 18px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        .report-number {
            font-size: 42px;
            font-weight: bold;
            color: #4a5ee5;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }

        .report-label {
            font-size: 15px;
            color: #666;
        }

        /* GiriÅŸ Formu */
        .login-form {
            max-width: 450px;
            margin: 0 auto;
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        }

        .welcome-text {
            font-size: 28px;
            margin-bottom: 30px;
            color: #667eea;
            font-weight: bold;
        }

        .user-info {
            background: rgba(102, 126, 234, 0.08);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            text-align: left;
            color: #555;
            font-size: 15px;
            line-height: 1.6;
        }

        .user-info p {
            margin-bottom: 5px;
        }

        .user-info strong {
            color: #667eea;
        }

        /* HÄ±zlÄ± giriÅŸ butonlarÄ± kaldÄ±rÄ±ldÄ± */

        /* Admin Paneli BÃ¶lÃ¼mleri */
        .section-header {
            background: rgba(248, 249, 250, 0.9);
            padding: 25px;
            border-radius: 18px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .section-header h3 {
            color: #4a5ee5;
            margin-bottom: 20px;
            font-size: 22px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Bildirim Stili */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 18px 25px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            font-size: 16px;
            z-index: 1000;
            transform: translateX(calc(100% + 30px));
            transition: transform 0.4s ease-out;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(45deg, #4caf50, #40a045);
        }

        .notification.error {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        /* Admin/Ã‡alÄ±ÅŸan Aksiyon ButonlarÄ± */
        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .status-controls {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .status-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            background-color: #f0f0f0;
            color: #555;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .status-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .status-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
        }

        /* Yeni durum buton renkleri */
        .status-btn.inqueue.active { background: linear-gradient(45deg, #bdbdbd, #9e9e9e); color: white; border-color: #9e9e9e; }
        .status-btn.exteriorwash.active { background: linear-gradient(45deg, #ffd54f, #ffc107); color: #a0522d; border-color: #ffc107; }
        .status-btn.dryingarea.active { background: linear-gradient(45deg, #a5d6a7, #66bb6a); color: #1b5e20; border-color: #66bb6a; }
        .status-btn.parkingarea.active { background: linear-gradient(45deg, #90caf9, #64b5f6); color: #1976d2; border-color: #64b5f6; }
        .status-btn.delivered.active { background: linear-gradient(45deg, #b0bec5, #78909c); color: white; border-color: #78909c; }


        /* DetaylÄ± AraÃ§ Listesi (Raporlar) */
        .detailed-car-list .car-card {
            background: #ffffff;
            border: 1px solid #eee;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        /* Responsive Ayarlamalar */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
                padding: 15px;
            }

            .nav-buttons {
                justify-content: center;
                width: 100%;
            }

            .nav-buttons .btn {
                flex-grow: 1;
            }

            .container {
                padding: 15px;
            }

            .screen {
                padding: 20px;
            }

            .car-details, .form-grid, .report-grid {
                grid-template-columns: 1fr;
            }

            .plate-number {
                font-size: 22px;
            }

            .search-input {
                font-size: 16px;
                height: 50px;
            }

            .search-icon {
                font-size: 20px;
            }

            .report-number {
                font-size: 36px;
            }

            .notification {
                top: 15px;
                right: 15px;
                left: 15px;
                transform: translateX(calc(100% + 15px));
            }

            .status-controls {
                flex-direction: column;
                align-items: center;
            }
            .status-btn {
                width: 80%;
            }
        }

        @media (max-width: 480px) {
            .btn {
                padding: 10px 15px;
                font-size: 13px;
            }

            .logo {
                font-size: 24px;
            }

            .login-form, .satisfaction-survey, .section-header {
                padding: 20px;
            }
            .welcome-text {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fa-solid fa-car-wash"></i> Oto YÄ±kama Takip Sistemi
            </div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="showLogin()" id="loginBtn"><i class="fa-solid fa-right-to-bracket"></i> GiriÅŸ Yap</button>
                <button class="btn btn-primary" onclick="showCustomerSearch()" id="customerBtn"><i class="fa-solid fa-magnifying-glass"></i> MÃ¼ÅŸteri Sorgu</button>
                <button class="btn btn-secondary" onclick="showEmployeePanel()" id="employeeBtn" style="display: none;"><i class="fa-solid fa-users-gear"></i> Ã‡alÄ±ÅŸan Paneli</button>
                <button class="btn btn-secondary" onclick="showAdminPanel()" id="adminBtn" style="display: none;"><i class="fa-solid fa-user-gear"></i> Admin Paneli</button>
                <button class="btn btn-secondary" onclick="showReports()" id="reportsBtn" style="display: none;"><i class="fa-solid fa-chart-line"></i> Raporlar</button>
                <button class="btn btn-danger" onclick="logout()" id="logoutBtn" style="display: none;"><i class="fa-solid fa-right-from-bracket"></i> Ã‡Ä±kÄ±ÅŸ</button>
            </div>
        </div>

        <!-- GiriÅŸ EkranÄ± -->
        <div id="loginScreen" class="screen">
            <div class="login-form">
                <h2 class="welcome-text">Sisteme HoÅŸ Geldiniz</h2>
                <div class="form-group">
                    <label for="username">KullanÄ±cÄ± AdÄ±</label>
                    <input type="text" id="username" placeholder="KullanÄ±cÄ± adÄ±nÄ±zÄ± girin" onkeypress="handleEnterKey(event)">
                </div>
                <div class="form-group">
                    <label for="password">Åifre</label>
                    <input type="password" id="password" placeholder="Åifrenizi girin" onkeypress="handleEnterKey(event)">
                </div>
                <button class="btn btn-primary" onclick="login()"><i class="fa-solid fa-sign-in-alt"></i> GiriÅŸ Yap</button>
                <!-- HÄ±zlÄ± GiriÅŸ ButonlarÄ± KaldÄ±rÄ±ldÄ± -->
                <div class="user-info">
                    <p><strong>Demo Hesaplar:</strong></p>
                    <p><i class="fa-solid fa-key"></i> Admin: <code>admin</code> / <code>668857</code></p>
                    <p><i class="fa-solid fa-user"></i> Ã‡alÄ±ÅŸan: <code>user1</code> / <code>user123</code></p>
                    <p style="margin-top: 10px;">Not: KullanÄ±cÄ± adÄ± ve ÅŸifre ile giriÅŸ yapÄ±n.</p>
                </div>
            </div>
        </div>

        <!-- MÃ¼ÅŸteri Sorgu EkranÄ± -->
        <div id="customerScreen" class="screen">
            <h2><i class="fa-solid fa-search"></i> AraÃ§ Durumu Sorgulama</h2>
            <div class="search-container">
                <div class="search-icon">ğŸ”</div>
                <input type="text" class="search-input" id="plateSearch" placeholder="Plaka numarasÄ±nÄ± girin (Ã¶rn: 34ABC123)" maxlength="8" oninput="searchCar()">
            </div>
            
            <div id="carResults">
                <p style="text-align: center; color: #777;">Plaka numarasÄ±nÄ± girerek araÃ§ durumunu sorgulayabilirsiniz.</p>
            </div>
            
            <div class="satisfaction-survey">
                <h3><i class="fa-solid fa-star-half-stroke"></i> Memnuniyet Anketi</h3>
                <p>Hizmetimizden ne kadar memnun kaldÄ±nÄ±z?</p>
                <div class="rating-stars" id="ratingStars">
                    <span class="star" onclick="setRating(1)">â­</span>
                    <span class="star" onclick="setRating(2)">â­</span>
                    <span class="star" onclick="setRating(3)">â­</span>
                    <span class="star" onclick="setRating(4)">â­</span>
                    <span class="star" onclick="setRating(5)">â­</span>
                </div>
                <div class="form-group">
                    <textarea id="feedbackText" placeholder="GÃ¶rÃ¼ÅŸ ve Ã¶nerilerinizi paylaÅŸÄ±n..." rows="3"></textarea>
                </div>
                <button class="btn btn-primary" id="submitFeedbackBtn" onclick="submitFeedback()"><i class="fa-solid fa-paper-plane"></i> Geri Bildirimi GÃ¶nder</button>
            </div>
        </div>

        <!-- Ã‡alÄ±ÅŸan Paneli -->
        <div id="employeeScreen" class="screen">
            <h2><i class="fa-solid fa-users-gear"></i> Ã‡alÄ±ÅŸan Paneli</h2>
            
            <!-- AraÃ§ Ekleme/DÃ¼zenleme -->
            <div class="section-header">
                <h3 id="carFormTitle"><i class="fa-solid fa-car-plus"></i> Yeni AraÃ§ Ekle</h3>
                <input type="hidden" id="currentEditingCarId"> <!-- DÃ¼zenlenen aracÄ±n Firestore ID'si -->
                <div class="form-grid">
                    <div class="form-group">
                        <label for="newPlate">Plaka</label>
                        <input type="text" id="newPlate" placeholder="Ã¶rn: 34ABC123, ABC1234" maxlength="15" oninput="this.value = this.value.toUpperCase()">
                        <div class="error-message" id="errorNewPlate"></div>
                    </div>
                    <div class="form-group">
                        <label for="customerName">MÃ¼ÅŸteri AdÄ± (Ä°steÄŸe BaÄŸlÄ±)</label>
                        <input type="text" id="customerName" placeholder="MÃ¼ÅŸteri adÄ±">
                        <div class="error-message" id="errorCustomerName"></div>
                    </div>
                    <div class="form-group">
                        <label for="customerPhone">Telefon (Ä°steÄŸe BaÄŸlÄ±)</label>
                        <input type="tel" id="customerPhone" placeholder="Ã¶rn: 05551234567" maxlength="11">
                        <div class="error-message" id="errorCustomerPhone"></div>
                    </div>
                    <div class="form-group">
                        <label for="carModel">AraÃ§ Modeli (Ä°steÄŸe BaÄŸlÄ±)</label>
                        <input type="text" id="carModel" placeholder="Marka Model">
                        <div class="error-message" id="errorCarModel"></div>
                    </div>
                    <div class="form-group">
                        <label for="serviceType">Hizmet TÃ¼rÃ¼</label>
                        <select id="serviceType">
                            <option value="DÄ±ÅŸ YÄ±kama">DÄ±ÅŸ YÄ±kama</option>
                            <option value="Ä°Ã§ DÄ±ÅŸ YÄ±kama">Ä°Ã§ DÄ±ÅŸ YÄ±kama</option>
                            <option value="Detay YÄ±kama">Detay YÄ±kama</option>
                            <option value="Cila & Koruma">Cila & Koruma</option>
                        </select>
                        <div class="error-message" id="errorServiceType"></div>
                    </div>
                    <div class="form-group">
                        <label for="carStatus">BaÅŸlangÄ±Ã§ Durumu</label>
                        <select id="carStatus">
                            <option value="inQueue">SÄ±rada</option>
                            <option value="exteriorWash">DÄ±ÅŸ YÄ±kamada</option>
                            <option value="dryingArea">Kurulama AlanÄ±nda</option>
                            <option value="parkingArea">Park AlanÄ±nda</option>
                            <option value="delivered">Teslim Edildi</option>
                        </select>
                        <div class="error-message" id="errorCarStatus"></div>
                    </div>
                    <div class="form-group">
                        <label for="estimatedTime">Tahmini SÃ¼re (dk) (Ä°steÄŸe BaÄŸlÄ±)</label>
                        <input type="number" id="estimatedTime" placeholder="Ã¶rn: 45" min="1">
                        <div class="error-message" id="errorEstimatedTime"></div>
                    </div>
                    <div class="form-group">
                        <label for="carPrice">Fiyat (â‚º) (Ä°steÄŸe BaÄŸlÄ±)</label>
                        <input type="number" id="carPrice" placeholder="Ã¶rn: 150" min="0">
                        <div class="error-message" id="errorCarPrice"></div>
                    </div>
                </div>
                <button class="btn btn-primary" id="submitCarBtn" onclick="handleAddOrUpdateCar()"><i class="fa-solid fa-car-rear"></i> AraÃ§ Ekle</button>
                <button class="btn btn-secondary" id="cancelCarEditBtn" style="display: none;" onclick="cancelCarEdit()"><i class="fa-solid fa-times"></i> VazgeÃ§</button>
            </div>

            <!-- Mevcut AraÃ§lar -->
            <h3><i class="fa-solid fa-list-check"></i> Mevcut AraÃ§lar</h3>
            <div id="employeeCarList">
                <p style="text-align: center; color: #777;">YÃ¼kleniyor...</p>
            </div>
        </div>

        <!-- Admin Paneli -->
        <div id="adminScreen" class="screen">
            <h2><i class="fa-solid fa-user-gear"></i> Admin Paneli</h2>
            
            <!-- KullanÄ±cÄ± Ekleme -->
            <div class="section-header">
                <h3><i class="fa-solid fa-user-plus"></i> Yeni KullanÄ±cÄ± Ekle</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="newUsername">KullanÄ±cÄ± AdÄ±</label>
                        <input type="text" id="newUsername" placeholder="KullanÄ±cÄ± adÄ±">
                        <div class="error-message" id="errorNewUsername"></div>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">Åifre</label>
                        <input type="password" id="newPassword" placeholder="Åifre">
                        <div class="error-message" id="errorNewPassword"></div>
                    </div>
                    <div class="form-group">
                        <label for="newUserRole">Rol</label>
                        <select id="newUserRole">
                            <option value="user">Ã‡alÄ±ÅŸan</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" id="addUserBtn" onclick="addUser()"><i class="fa-solid fa-plus-circle"></i> KullanÄ±cÄ± Ekle</button>
            </div>

            <!-- KullanÄ±cÄ± Åifrelerini YÃ¶net -->
            <div class="section-header">
                <h3><i class="fa-solid fa-user-lock"></i> KullanÄ±cÄ± Åifrelerini YÃ¶net</h3>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                    Bu demo uygulamasÄ±nda, kullanÄ±cÄ± ÅŸifreleri sadece yerel demo hesabÄ± iÃ§in gÃ¼ncellenir. GerÃ§ek Firebase Auth projenizde,
                    baÅŸka bir kullanÄ±cÄ±nÄ±n ÅŸifresini yÃ¶netmek iÃ§in <a href="https://firebase.google.com/docs/auth/admin/manage-users#update_a_user" target="_blank" style="color: #667eea; text-decoration: underline;">Firebase Admin SDK</a> kullanmanÄ±z gerekir (arka uÃ§ sunucunuzda).
                </p>
                <div class="form-group">
                    <label for="selectUserForPasswordReset">Åifresi DeÄŸiÅŸecek KullanÄ±cÄ±</label>
                    <select id="selectUserForPasswordReset">
                        <option value="">KullanÄ±cÄ± SeÃ§in</option>
                        <!-- KullanÄ±cÄ±lar JS ile doldurulacak -->
                    </select>
                    <div class="error-message" id="errorSelectUserForPasswordReset"></div>
                </div>
                <div class="form-group">
                    <label for="selectedUserNewPassword">Yeni Åifre</label>
                    <input type="password" id="selectedUserNewPassword" placeholder="Yeni ÅŸifreyi girin">
                    <div class="error-message" id="errorSelectedUserNewPassword"></div>
                </div>
                <div class="form-group">
                    <label for="confirmSelectedUserNewPassword">Yeni Åifre Tekrar</label>
                    <input type="password" id="confirmSelectedUserNewPassword" placeholder="Yeni ÅŸifreyi tekrar girin">
                    <div class="error-message" id="errorConfirmSelectedUserNewPassword"></div>
                </div>
                <button class="btn btn-primary" id="resetSelectedUserPasswordBtn" onclick="resetSelectedUserPassword()"><i class="fa-solid fa-unlock"></i> Åifreyi SÄ±fÄ±rla</button>
            </div>
            
            <!-- Åifremi DeÄŸiÅŸtir (GiriÅŸ YapmÄ±ÅŸ KullanÄ±cÄ±nÄ±n Kendi Åifresi) -->
            <div class="section-header">
                <h3><i class="fa-solid fa-key"></i> Åifremi DeÄŸiÅŸtir (Kendi HesabÄ±nÄ±z)</h3>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                    Bu demo uygulamasÄ±nda, ÅŸifreler sadece yerel demo hesabÄ± iÃ§in gÃ¼ncellenir. GerÃ§ek Firebase Auth projenizde,
                    kendi ÅŸifrenizi deÄŸiÅŸtirmek iÃ§in <a href="https://firebase.google.com/docs/auth/web/manage-users#update_a_users_password" target="_blank" style="color: #667eea; text-decoration: underline;">Firebase Auth belgelerine</a> baÅŸvurun.
                </p>
                <div class="form-group">
                    <label for="oldPassword">Eski Åifre</label>
                    <input type="password" id="oldPassword" placeholder="Eski ÅŸifrenizi girin">
                    <div class="error-message" id="errorOldPassword"></div>
                </div>
                <div class="form-group">
                    <label for="newAuthPassword">Yeni Åifre</label>
                    <input type="password" id="newAuthPassword" placeholder="Yeni ÅŸifrenizi girin">
                    <div class="error-message" id="errorNewAuthPassword"></div>
                </div>
                <div class="form-group">
                    <label for="confirmNewAuthPassword">Yeni Åifre Tekrar</label>
                    <input type="password" id="confirmNewAuthPassword" placeholder="Yeni ÅŸifrenizi tekrar girin">
                    <div class="error-message" id="errorConfirmNewAuthPassword"></div>
                </div>
                <button class="btn btn-primary" id="changeMyOwnPasswordBtn" onclick="changeMyOwnPassword()"><i class="fa-solid fa-lock"></i> Åifremi DeÄŸiÅŸtir</button>
            </div>

            <!-- Mevcut KullanÄ±cÄ±lar (Demo AmaÃ§lÄ± Listeleme) -->
            <h3><i class="fa-solid fa-users"></i> Mevcut KullanÄ±cÄ±lar (Demo Listesi)</h3>
            <div id="userList" class="section-header" style="background:none; box-shadow:none;">
                <p style="text-align: center; color: #777;">YÃ¼kleniyor...</p>
            </div>
        </div>

        <!-- Raporlar -->
        <div id="reportsScreen" class="screen">
            <h2><i class="fa-solid fa-chart-simple"></i> GÃ¼nlÃ¼k Raporlar</h2>
            
            <div class="report-grid">
                <div class="report-card">
                    <div class="report-number" id="totalCars">0</div>
                    <div class="report-label">Toplam AraÃ§</div>
                </div>
                <div class="report-card">
                    <div class="report-number" id="washingCars">0</div>
                    <div class="report-label">DÄ±ÅŸ YÄ±kamada</div>
                </div>
                <div class="report-card">
                    <div class="report-number" id="readyCars">0</div>
                    <div class="report-label">Kurulama AlanÄ±nda</div>
                </div>
                <div class="report-card">
                    <div class="report-number" id="deliveredCars">0</div>
                    <div class="report-label">Teslim Edildi</div>
                </div>
                <div class="report-card">
                    <div class="report-number" id="avgRating">0.0</div>
                    <div class="report-label">Ortalama Puan</div>
                </div>
                <div class="report-card">
                    <div class="report-number" id="totalRevenue">â‚º0</div>
                    <div class="report-label">Toplam Gelir</div>
                </div>
            </div>

            <div class="section-header detailed-car-list">
                <h3><i class="fa-solid fa-table-list"></i> DetaylÄ± AraÃ§ Listesi</h3>
                <div id="detailedCarList">
                    <p style="text-align: center; color: #777;">YÃ¼kleniyor...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bildirim -->
    <div id="notification" class="notification"></div>

    <script type="module">
        // Firebase ModÃ¼llerinin ImportlarÄ± (v9 SDK'dan doÄŸrudan import)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, fetchSignInMethodsForEmail, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, onSnapshot, where, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        
        // --- Firebase YapÄ±landÄ±rmasÄ± (KullanÄ±cÄ± TarafÄ±ndan SaÄŸlandÄ±) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA6X-ZdiA11kK4R0D-09qlboQKmzhFOq1o",
            authDomain: "projecty-3d9d1.firebaseapp.com",
            projectId: "projecty-3d9d1",
            storageBucket: "projecty-3d9d1.firebasestorage.app",
            messagingSenderId: "158211801481",
            appId: "1:158211801481:web:78494e1dfed54e98a56158",
            measurementId: "G-B6V1Y6HT2Y"
        };
        // Firestore koleksiyon yollarÄ± iÃ§in kullanÄ±lacak uygulama kimliÄŸi (proje kimliÄŸi)
        const APP_ID_FOR_FIRESTORE_PATHS = firebaseConfig.projectId;


        // --- Global DeÄŸiÅŸkenler ---
        // Bu deÄŸiÅŸkenler window objesine atanarak HTML event handler'larÄ±ndan eriÅŸilebilir hale getirilir.
        window.currentUser = null;
        window.selectedRating = 0;
        window.cars = []; // Firestore'dan Ã§ekilecek dinamik veriler
        window.feedback = []; // Firestore'dan Ã§ekilecek dinamik veriler

        // Demo kullanÄ±cÄ±larÄ± Firebase Auth'tan Ã§ekileceÄŸi iÃ§in bu dizi sadece baÅŸlangÄ±Ã§ta tanÄ±mlanacak
        // ve Firebase'deki rollerle eÅŸleÅŸtirilecek.
        const LOCAL_DEMO_USERS = [
            { username: "admin", email: `admin@${APP_ID_FOR_FIRESTORE_PATHS}.com`, password: "668857", role: "admin" }, // Admin ÅŸifresi gÃ¼ncellendi
            { username: "user1", email: `user1@${APP_ID_FOR_FIRESTORE_PATHS}.com`, password: "user123", role: "user" }
        ];

        // Firebase instance'larÄ± (window objesine atanÄ±r)
        window.firebaseApp = null;
        window.firestoreDb = null;
        window.firebaseAuth = null;
        window.currentUserId = null; // Firebase Auth UID'si
        window.isFirebaseReady = false;

        // Firestore koleksiyon referanslarÄ± (window objesine atanÄ±r)
        window.carsCollectionRef = null;
        window.feedbackCollectionRef = null;
        window.historicalCarsCollectionRef = null; // ArÅŸivlenmiÅŸ araÃ§lar
        window.historicalFeedbackCollectionRef = null; // ArÅŸivlenmiÅŸ geri bildirimler
        window.settingsDocRef = null; // GÃ¼nlÃ¼k temizlik ayarlarÄ± iÃ§in
        window.userRolesCollectionRef = null; // KullanÄ±cÄ± rolleri iÃ§in yeni koleksiyon

        // Firestore Dinleyicileri iÃ§in unsubscribe fonksiyonlarÄ±
        let carsUnsubscribe = null;
        let feedbackUnsubscribe = null;
        let userRolesUnsubscribe = null;

        // --- Firebase BaÅŸlatma ve YÃ¶netim FonksiyonlarÄ± ---

        /**
         * Firebase'i baÅŸlatÄ±r ve kimlik doÄŸrulama durumunu yÃ¶netir.
         * window.onload tarafÄ±ndan Ã§aÄŸrÄ±lÄ±r.
         */
        async function initializeFirebaseAndAuth() {
            console.log("Firebase baÅŸlatÄ±lÄ±yor...");
            try {
                // Firebase uygulamalarÄ±nÄ± ve servislerini baÅŸlat
                window.firebaseApp = initializeApp(firebaseConfig);
                window.firestoreDb = getFirestore(window.firebaseApp);
                window.firebaseAuth = getAuth(window.firebaseApp);

                // Koleksiyon referanslarÄ±nÄ± tanÄ±mla
                window.carsCollectionRef = collection(window.firestoreDb, 'artifacts', APP_ID_FOR_FIRESTORE_PATHS, 'public', 'data', 'cars');
                window.feedbackCollectionRef = collection(window.firestoreDb, 'artifacts', APP_ID_FOR_FIRESTORE_PATHS, 'public', 'data', 'feedback');
                window.historicalCarsCollectionRef = collection(window.firestoreDb, 'artifacts', APP_ID_FOR_FIRESTORE_PATHS, 'public', 'data', 'historical_cars');
                window.historicalFeedbackCollectionRef = collection(window.firestoreDb, 'artifacts', APP_ID_FOR_FIRESTORE_PATHS, 'public', 'data', 'historical_feedback');
                window.settingsDocRef = doc(window.firestoreDb, 'artifacts', APP_ID_FOR_FIRESTORE_PATHS, 'public', 'data', 'settings', 'daily_cleanup');
                window.userRolesCollectionRef = collection(window.firestoreDb, 'artifacts', APP_ID_FOR_FIRESTORE_PATHS, 'public', 'data', 'user_roles');
                
                console.log("Firebase servisleri baÅŸlatÄ±ldÄ±. Project ID:", APP_ID_FOR_FIRESTORE_PATHS);

                // Kimlik doÄŸrulama durumu deÄŸiÅŸtiÄŸinde tetiklenir
                onAuthStateChanged(window.firebaseAuth, async (user) => {
                    if (user) {
                        window.currentUserId = user.uid;
                        // KullanÄ±cÄ±nÄ±n rolÃ¼nÃ¼ Firestore'dan Ã§ek
                        const userRoleDoc = await getDoc(doc(window.userRolesCollectionRef, user.uid));
                        if (userRoleDoc.exists()) {
                            window.currentUser = { 
                                uid: user.uid, 
                                email: user.email, 
                                username: userRoleDoc.data().username, 
                                role: userRoleDoc.data().role 
                            };
                            localStorage.setItem('currentUser', JSON.stringify(window.currentUser)); // Oturumu gÃ¼ncelle
                            console.log("Firebase Auth Durumu DeÄŸiÅŸti: GiriÅŸ yapÄ±ldÄ± ve rol Ã§ekildi:", window.currentUser);
                        } else {
                            // Rol kaydÄ± yoksa, anonim gibi davran veya varsayÄ±lan rol ver
                            window.currentUser = { 
                                uid: user.uid, 
                                email: user.email, 
                                username: user.email ? user.email.split('@')[0] : `Anonim-${user.uid.substring(0,4)}`, 
                                role: 'guest' 
                            };
                            localStorage.removeItem('currentUser'); // RolÃ¼ olmayan kullanÄ±cÄ±yÄ± hatÄ±rlama
                            console.warn("KullanÄ±cÄ±nÄ±n rolÃ¼ bulunamadÄ±, varsayÄ±lan misafir rolÃ¼ atandÄ±.");
                        }
                    } else {
                        // Anonim veya Ã§Ä±kÄ±ÅŸ yapÄ±lmÄ±ÅŸsa, local storage'dan kullanÄ±cÄ±yÄ± temizle
                        window.currentUser = null;
                        localStorage.removeItem('currentUser');
                        console.log("Firebase Auth Durumu DeÄŸiÅŸti: Oturum kapatÄ±ldÄ±.");
                    }
                    window.isFirebaseReady = true;
                    console.log("Firebase hazÄ±r bayraÄŸÄ± ayarlandÄ±. appReadySetup Ã§aÄŸrÄ±lÄ±yor.");
                    await appReadySetup();
                });

                // BaÅŸlangÄ±Ã§ kimlik doÄŸrulamasÄ±nÄ± yap (anonim giriÅŸ)
                // Bu anonim kullanÄ±cÄ±, Firestore'daki verilere okuma/yazma izni veren gÃ¼venlik kurallarÄ±nÄ±z sayesinde eriÅŸebilir.
                console.log("Anonim giriÅŸ deniyor...");
                await signInAnonymously(window.firebaseAuth);
                console.log("Anonim olarak giriÅŸ yapÄ±ldÄ±.");

            } catch (e) {
                console.error("Firebase baÅŸlatma veya kimlik doÄŸrulama baÅŸarÄ±sÄ±z oldu:", e);
                showNotification("Firebase baÅŸlatÄ±lÄ±rken veya baÄŸlanÄ±rken hata oluÅŸtu!", "error");
            }
        }

        /**
         * Firebase baÄŸlantÄ±sÄ± kurulduktan sonra Firestore dinleyicilerini ayarlar.
         * window.cars, window.feedback ve user_roles'Ä± gerÃ§ek zamanlÄ± olarak gÃ¼nceller.
         */
        function setupFirestoreListeners() {
            if (!window.firestoreDb) {
                console.error("Firestore DB baÅŸlatÄ±lmadÄ±. Dinleyiciler ayarlanamÄ±yor.");
                return;
            }
            // Mevcut dinleyicileri kapat
            if (carsUnsubscribe) carsUnsubscribe();
            if (feedbackUnsubscribe) feedbackUnsubscribe();
            if (userRolesUnsubscribe) userRolesUnsubscribe();

            console.log("Firestore dinleyicileri ayarlanÄ±yor...");

            // Arabalar koleksiyonu iÃ§in dinleyici
            carsUnsubscribe = onSnapshot(query(window.carsCollectionRef), (snapshot) => {
                window.cars = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Firestore'dan araÃ§lar gÃ¼ncellendi. AraÃ§ sayÄ±sÄ±:", window.cars.length);
                if (document.getElementById('employeeScreen').classList.contains('active')) {
                    renderEmployeeCarList();
                }
                if (document.getElementById('reportsScreen').classList.contains('active')) {
                    renderReports();
                }
                const plateSearchInput = document.getElementById('plateSearch');
                if (document.getElementById('customerScreen').classList.contains('active') && plateSearchInput.value.trim().length > 1) {
                    searchCar();
                }
            }, (error) => {
                console.error("Cars collection snapshot error:", error);
                showNotification("AraÃ§ verileri yÃ¼klenirken hata oluÅŸtu!", "error");
            });

            // Geri bildirimler koleksiyonu iÃ§in dinleyici
            feedbackUnsubscribe = onSnapshot(query(window.feedbackCollectionRef), (snapshot) => {
                window.feedback = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Firestore'dan geri bildirimler gÃ¼ncellendi. Geri bildirim sayÄ±sÄ±:", window.feedback.length);
                if (document.getElementById('reportsScreen').classList.contains('active')) {
                    renderReports();
                }
            }, (error) => {
                console.error("Feedback collection snapshot error:", error);
                showNotification("Geri bildirim verileri yÃ¼klenirken hata oluÅŸtu!", "error");
            });

            // KullanÄ±cÄ± rolleri koleksiyonu iÃ§in dinleyici (Admin paneli iÃ§in)
            userRolesUnsubscribe = onSnapshot(query(window.userRolesCollectionRef), (snapshot) => {
                window.users = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
                console.log("Firestore'dan kullanÄ±cÄ± rolleri gÃ¼ncellendi. KullanÄ±cÄ± sayÄ±sÄ±:", window.users.length);
                if (document.getElementById('adminScreen').classList.contains('active')) {
                    renderUserList();
                    populateUserSelectionForPasswordReset();
                }
                // EÄŸer mevcut kullanÄ±cÄ±nÄ±n rolÃ¼ deÄŸiÅŸtiyse UI'Ä± gÃ¼ncelle
                if (window.currentUser && window.users.find(u => u.uid === window.currentUser.uid)?.role !== window.currentUser.role) {
                    const updatedRole = window.users.find(u => u.uid === window.currentUser.uid)?.role;
                    if (updatedRole) {
                        window.currentUser.role = updatedRole;
                        localStorage.setItem('currentUser', JSON.stringify(window.currentUser));
                        updateUI();
                    }
                }
            }, (error) => {
                console.error("User roles collection snapshot error:", error);
                showNotification("KullanÄ±cÄ± verileri yÃ¼klenirken hata oluÅŸtu!", "error");
            });
        }

        /**
         * Firebase hazÄ±r olduÄŸunda Ã§alÄ±ÅŸacak ana kurulum fonksiyonu.
         */
        async function appReadySetup() {
            if (!window.isFirebaseReady) {
                console.warn("appReadySetup Ã§aÄŸrÄ±ldÄ± ama Firebase henÃ¼z hazÄ±r deÄŸil.");
                return;
            }
            console.log("appReadySetup baÅŸlatÄ±lÄ±yor...");

            // Firebase'de baÅŸlangÄ±Ã§ admin kullanÄ±cÄ±sÄ±nÄ± ve rollerini oluÅŸtur.
            // Bu kÄ±sÄ±m, uygulamanÄ±n ilk defa Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± iÃ§in tasarlanmÄ±ÅŸtÄ±r.
            // GerÃ§ek bir uygulamada bu, daha gÃ¼venli bir ÅŸekilde sunucu tarafÄ±nda yapÄ±lmalÄ±dÄ±r.
            await ensureInitialDemoUsers();

            setupFirestoreListeners(); // Firestore dinleyicilerini baÅŸlat
            await performDailyCleanup(); // GÃ¼nlÃ¼k temizliÄŸi Ã§alÄ±ÅŸtÄ±r ve arÅŸivle

            // localStorage'dan kullanÄ±cÄ± oturumunu geri yÃ¼klemeyi dene
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                // localStorage'daki kullanÄ±cÄ± bilgisi, Firebase Auth'tan gelen UID ile eÅŸleÅŸmeli
                if (window.firebaseAuth.currentUser && window.firebaseAuth.currentUser.uid === JSON.parse(storedUser).uid) {
                    window.currentUser = JSON.parse(storedUser);
                    console.log("KullanÄ±cÄ± localStorage'dan geri yÃ¼klendi:", window.currentUser.username);
                } else {
                    // localStorage'daki kullanÄ±cÄ± mevcut Firebase oturumuyla eÅŸleÅŸmiyorsa temizle
                    window.currentUser = null;
                    localStorage.removeItem('currentUser');
                    console.log("localStorage'daki kullanÄ±cÄ± mevcut Firebase oturumuyla eÅŸleÅŸmiyor, temizlendi.");
                }
            } else {
                console.log("localStorage'da kullanÄ±cÄ± bulunamadÄ±.");
            }
            
            window.updateUI(); // Global updateUI Ã§aÄŸrÄ±ldÄ±
            // GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±larÄ± ilgili panellerine yÃ¶nlendir, aksi takdirde mÃ¼ÅŸteri sorgu ekranÄ±nÄ± gÃ¶ster
            if (window.currentUser && window.currentUser.role === 'admin') {
                window.showAdminPanel(); // Global showAdminPanel Ã§aÄŸrÄ±ldÄ±
            } else if (window.currentUser && window.currentUser.role === 'user') {
                window.showEmployeePanel(); // Global showEmployeePanel Ã§aÄŸrÄ±ldÄ±
            } else {
                window.showCustomerSearch(); // Uygulama aÃ§Ä±ldÄ±ÄŸÄ±nda varsayÄ±lan ekran: MÃ¼ÅŸteri Sorgu (Global showCustomerSearch Ã§aÄŸrÄ±ldÄ±)
            }
        }

        /**
         * Uygulamada tanÄ±mlanmÄ±ÅŸ demo kullanÄ±cÄ±larÄ±nÄ±n Firebase Auth ve Firestore'da var olduÄŸundan emin olur.
         * Ã–zellikle admin kullanÄ±cÄ±sÄ±nÄ±n ilk Ã§alÄ±ÅŸtÄ±rmada oluÅŸturulmasÄ±nÄ± saÄŸlar.
         */
        async function ensureInitialDemoUsers() {
            console.log("BaÅŸlangÄ±Ã§ demo kullanÄ±cÄ±larÄ±nÄ± kontrol ediyor ve oluÅŸturuyor...");
            for (const demoUser of LOCAL_DEMO_USERS) {
                try {
                    // KullanÄ±cÄ±yÄ± e-posta ile giriÅŸ yapmayÄ± dene
                    const userCredential = await signInWithEmailAndPassword(window.firebaseAuth, demoUser.email, demoUser.password);
                    console.log(`KullanÄ±cÄ± ${demoUser.username} Firebase Auth'ta zaten var.`);
                    
                    // Rol kaydÄ±nÄ±n Firestore'da var olduÄŸundan emin ol
                    const userRoleDocRef = doc(window.userRolesCollectionRef, userCredential.user.uid);
                    const userRoleDoc = await getDoc(userRoleDocRef);
                    if (!userRoleDoc.exists()) {
                        await setDoc(userRoleDocRef, { username: demoUser.username, email: demoUser.email, role: demoUser.role });
                        console.log(`KullanÄ±cÄ± ${demoUser.username} iÃ§in Firestore rolÃ¼ eklendi.`);
                    }

                } catch (error) {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        // KullanÄ±cÄ± bulunamazsa veya ÅŸifre yanlÄ±ÅŸsa, yeni kullanÄ±cÄ± olarak oluÅŸtur.
                        // YALNIZCA DEMO VE Ä°LK KURULUM Ä°Ã‡Ä°N KULLANILIR. GERÃ‡EK UYGULAMADA YÃ–NETÄ°CÄ° HESAPLARI BÃ–YLE OLUÅTURULMAZ.
                        try {
                            const newUserCredential = await createUserWithEmailAndPassword(window.firebaseAuth, demoUser.email, demoUser.password);
                            await setDoc(doc(window.userRolesCollectionRef, newUserCredential.user.uid), { username: demoUser.username, email: demoUser.email, role: demoUser.role });
                            console.log(`KullanÄ±cÄ± ${demoUser.username} baÅŸarÄ±yla oluÅŸturuldu ve rolÃ¼ atandÄ±.`);
                        } catch (createError) {
                            console.error(`KullanÄ±cÄ± ${demoUser.username} oluÅŸturulurken hata:`, createError);
                            window.showNotification(`Demo kullanÄ±cÄ± ${demoUser.username} oluÅŸturulamadÄ±: ${createError.message}`, 'error'); // Global showNotification Ã§aÄŸrÄ±ldÄ±
                        }
                    } else {
                        console.error(`KullanÄ±cÄ± ${demoUser.username} kontrol edilirken beklenmeyen hata:`, error);
                    }
                }
            }
        }
        
        // --- Genel YardÄ±mcÄ± Fonksiyonlar ---

        /**
         * TÃ¼m ekranlarÄ± gizler ve belirtilen ekranÄ± gÃ¶sterir.
         * @param {string} screenId - GÃ¶sterilecek ekranÄ±n ID'si.
         */
        window.showScreen = function(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        };

        /**
         * Navigasyon butonlarÄ±nÄ±n gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ mevcut kullanÄ±cÄ±nÄ±n kimlik doÄŸrulama durumu ve rolÃ¼ne gÃ¶re gÃ¼nceller.
         */
        window.updateUI = function() {
            const loginBtn = document.getElementById('loginBtn');
            const customerBtn = document.getElementById('customerBtn');
            const employeeBtn = document.getElementById('employeeBtn');
            const adminBtn = document.getElementById('adminBtn');
            const reportsBtn = document.getElementById('reportsBtn');
            const logoutBtn = document.getElementById('logoutBtn');

            // MÃ¼ÅŸteri sorgu butonu her zaman gÃ¶rÃ¼nÃ¼r
            customerBtn.style.display = 'block';

            // EÄŸer Firebase Auth'tan gerÃ§ek bir kullanÄ±cÄ± oturum aÃ§mÄ±ÅŸsa (anonim deÄŸilse)
            if (window.firebaseAuth.currentUser && !window.firebaseAuth.currentUser.isAnonymous && window.currentUser) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                
                if (window.currentUser.role === 'user') { // Ã‡alÄ±ÅŸan rolÃ¼
                    employeeBtn.style.display = 'block';
                    adminBtn.style.display = 'none';
                    reportsBtn.style.display = 'none';
                } else if (window.currentUser.role === 'admin') { // Admin rolÃ¼
                    employeeBtn.style.display = 'block'; // Adminler de Ã§alÄ±ÅŸan panelini kullanabilir
                    adminBtn.style.display = 'block';
                    reportsBtn.style.display = 'block';
                } else { // RolÃ¼ tanÄ±mlÄ± deÄŸilse
                    employeeBtn.style.display = 'none';
                    adminBtn.style.display = 'none';
                    reportsBtn.style.display = 'none';
                }
            } else {
                // GiriÅŸ yapÄ±lmamÄ±ÅŸsa veya anonim ise
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                employeeBtn.style.display = 'none';
                adminBtn.style.display = 'none';
                reportsBtn.style.display = 'none';
            }
        };

        /**
         * EkranÄ±n saÄŸ Ã¼stÃ¼nde bir bildirim mesajÄ± gÃ¶sterir.
         * @param {string} message - GÃ¶sterilecek mesaj.
         * @param {'success'|'error'|'info'} type - Bildirim tÃ¼rÃ¼ (rengi belirler).
         */
        window.showNotification = function(message, type) {
            const notification = document.getElementById('notification');
            if (!notification) {
                console.error("Bildirim elementi bulunamadÄ±!");
                return;
            }
            notification.textContent = message;
            notification.className = `notification ${type}`; // SÄ±nÄ±flarÄ± sÄ±fÄ±rla ve tÃ¼rÃ¼ ekle
            // TÃ¼re gÃ¶re ikon ekle
            if (type === 'success') {
                notification.innerHTML = '<i class="fa-solid fa-check-circle"></i> ' + message;
            } else if (type === 'error') {
                notification.innerHTML = '<i class="fa-solid fa-times-circle"></i> ' + message;
            } else if (type === 'info') {
                notification.innerHTML = '<i class="fa-solid fa-info-circle"></i> ' + message;
            }
            
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000); // 3 saniye sonra bildirim kaybolur
        };

        /**
         * Belirtilen bir butonu asenkron bir iÅŸlem sÄ±rasÄ±nda devre dÄ±ÅŸÄ± bÄ±rakÄ±r/etkinleÅŸtirir.
         * @param {string} buttonId - Butonun ID'si.
         * @param {boolean} disabled - Devre dÄ±ÅŸÄ± bÄ±rakmak iÃ§in true, etkinleÅŸtirmek iÃ§in false.
         */
        function toggleButtonState(buttonId, disabled) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.disabled = disabled;
            }
        }

        /**
         * Form alanlarÄ±nÄ± doÄŸrular ve hata mesajlarÄ±nÄ± gÃ¶sterir.
         * @param {Array<Object>} fields - DoÄŸrulanacak alanlarÄ±n listesi.
         * @returns {boolean} TÃ¼m alanlar geÃ§erliyse true, aksi takdirde false.
         */
        function validateForm(fields) {
            let isValid = true;
            fields.forEach(field => {
                const inputElement = document.getElementById(field.id);
                const errorElement = document.getElementById(`error${capitalizeFirstLetter(field.id)}`);
                if (!inputElement) {
                    console.warn(`Input elementi bulunamadÄ±: ${field.id}`);
                    return;
                }
                
                inputElement.classList.remove('is-invalid');
                if (errorElement) errorElement.textContent = ''; // Hata mesajÄ±nÄ± temizle

                let errorMessage = '';
                const inputValue = inputElement.value.trim();

                if (field.required && !inputValue) {
                    errorMessage = field.name + ' alanÄ± boÅŸ bÄ±rakÄ±lamaz.';
                } else if (inputValue) { // EÄŸer deÄŸer girilmiÅŸse Ã¶zel validasyonlarÄ± uygula
                    if (field.type === 'phone' && !/^\d{10,11}$/.test(inputValue)) {
                        errorMessage = 'Telefon numarasÄ± 10 veya 11 hane olmalÄ± ve sadece rakamlardan oluÅŸmalÄ±dÄ±r.';
                    } else if (field.type === 'number' && (isNaN(parseFloat(inputValue)) || parseFloat(inputValue) < (field.min || 0))) {
                        errorMessage = field.name + ' pozitif bir sayÄ± olmalÄ±dÄ±r.';
                    } else if (field.type === 'password' && inputValue.length < 6) {
                        errorMessage = field.name + ' en az 6 karakter olmalÄ±dÄ±r.';
                    } else if (field.type === 'confirmPassword') {
                        const passwordInput = document.getElementById(field.matchId);
                        if (inputValue !== passwordInput.value) {
                            errorMessage = 'Åifreler eÅŸleÅŸmiyor.';
                        }
                    }
                }

                if (errorMessage) {
                    inputElement.classList.add('is-invalid');
                    if (errorElement) errorElement.textContent = errorMessage;
                    isValid = false;
                }
            });
            return isValid;
        }

        /**
         * GiriÅŸ alanlarÄ±nda Enter tuÅŸuna basÄ±ldÄ±ÄŸÄ±nda giriÅŸi tetikler.
         * @param {KeyboardEvent} event - Klavye olayÄ±.
         */
        window.handleEnterKey = function(event) {
            if (event.key === 'Enter') {
                window.login();
            }
        };

        /**
         * SaÄŸlanan kimlik bilgileriyle bir kullanÄ±cÄ± giriÅŸi yapmaya Ã§alÄ±ÅŸÄ±r.
         */
        window.login = async function() {
            console.log("login() Ã§aÄŸrÄ±ldÄ±.");
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            
            // Ã–nceki doÄŸrulama stillerini/mesajlarÄ±nÄ± temizle
            usernameInput.classList.remove('is-invalid');
            passwordInput.classList.remove('is-invalid');
            
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            let isValid = true;
            if (!username) {
                usernameInput.classList.add('is-invalid');
                isValid = false;
            }
            if (!password) {
                passwordInput.classList.add('is-invalid');
                isValid = false;
            }
            if (!isValid) {
                showNotification('KullanÄ±cÄ± adÄ± ve ÅŸifre giriniz!', 'error');
                return;
            }

            // KullanÄ±cÄ± adÄ±nÄ± e-posta adresine eÅŸle (demo kullanÄ±cÄ±larÄ± iÃ§in)
            const userMapping = LOCAL_DEMO_USERS.find(u => u.username === username);
            if (!userMapping) {
                showNotification('KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±!', 'error');
                usernameInput.classList.add('is-invalid');
                passwordInput.classList.add('is-invalid');
                console.log("GiriÅŸ baÅŸarÄ±sÄ±z: KullanÄ±cÄ± adÄ± bulunamadÄ±.");
                return;
            }

            console.log(`GiriÅŸ denemesi: KullanÄ±cÄ± AdÄ±: ${username} (Email: ${userMapping.email})`);
            
            try {
                // Firebase Auth ile giriÅŸ yap
                const userCredential = await signInWithEmailAndPassword(window.firebaseAuth, userMapping.email, password);
                const user = userCredential.user;

                // KullanÄ±cÄ±nÄ±n rolÃ¼nÃ¼ Firestore'dan Ã§ek
                const userRoleDoc = await getDoc(doc(window.userRolesCollectionRef, user.uid));
                if (userRoleDoc.exists()) {
                    window.currentUser = { 
                        uid: user.uid, 
                        email: user.email, 
                        username: userRoleDoc.data().username, 
                        role: userRoleDoc.data().role 
                    };
                    localStorage.setItem('currentUser', JSON.stringify(window.currentUser)); // Oturumu gÃ¼ncelle
                    window.updateUI();
                    window.showNotification(`HoÅŸ geldiniz ${window.currentUser.username}!`, 'success');
                    // Role gÃ¶re yÃ¶nlendirme
                    if (window.currentUser.role === 'admin') {
                        window.showAdminPanel(); 
                    } else if (window.currentUser.role === 'user') {
                        window.showEmployeePanel();
                    }
                    usernameInput.value = ''; // AlanlarÄ± temizle
                    passwordInput.value = '';
                    console.log("GiriÅŸ baÅŸarÄ±lÄ±. KullanÄ±cÄ±:", window.currentUser.username, "YÃ¶nlendiriliyor...");
                } else {
                    // Firebase Auth'ta var ama Firestore'da rolÃ¼ yoksa
                    window.showNotification('KullanÄ±cÄ± rolÃ¼ bulunamadÄ±. LÃ¼tfen yÃ¶neticinize baÅŸvurun!', 'error');
                    await signOut(window.firebaseAuth); // Oturumu kapat
                    console.log("GiriÅŸ baÅŸarÄ±sÄ±z: KullanÄ±cÄ± rolÃ¼ bulunamadÄ±.");
                }
            } catch (error) {
                let errorMessage = 'GiriÅŸ baÅŸarÄ±sÄ±z. KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±!';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = 'KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±!';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Ã‡ok fazla hatalÄ± deneme. LÃ¼tfen daha sonra tekrar deneyin.';
                } else {
                    console.error("GiriÅŸ hatasÄ±:", error);
                }
                window.showNotification(errorMessage, 'error');
                usernameInput.classList.add('is-invalid');
                passwordInput.classList.add('is-invalid');
            }
        };

        /**
         * Mevcut kullanÄ±cÄ±yÄ± Firebase Auth'tan ve yerel depolamadan Ã§Ä±kÄ±ÅŸ yapar.
         */
        window.logout = async function() {
            try {
                await signOut(window.firebaseAuth); // Firebase Auth'tan Ã§Ä±kÄ±ÅŸ yap
                window.currentUser = null;
                localStorage.removeItem('currentUser'); // KalÄ±cÄ± durumu temizle
                window.updateUI();
                window.showLogin(); // GiriÅŸ ekranÄ±na dÃ¶n
                window.showNotification('BaÅŸarÄ±yla Ã§Ä±kÄ±ÅŸ yapÄ±ldÄ±!', 'success');
                console.log("KullanÄ±cÄ± Firebase Auth'tan ve yerel depolamadan Ã§Ä±kÄ±ÅŸ yaptÄ±.");
            } catch (error) {
                console.error("Ã‡Ä±kÄ±ÅŸ sÄ±rasÄ±nda hata oluÅŸtu:", error);
                window.showNotification("Ã‡Ä±kÄ±ÅŸ sÄ±rasÄ±nda hata oluÅŸtu!", "error");
            }
        };

        /**
         * HÄ±zlÄ± giriÅŸ butonlarÄ± kaldÄ±rÄ±ldÄ±. Bu fonksiyon artÄ±k kullanÄ±lmÄ±yor.
         */
        // window.quickLogin = function(roleType) { ... }; // Fonksiyon kaldÄ±rÄ±ldÄ±.

        /**
         * GiriÅŸ ekranÄ±nÄ± gÃ¶sterir.
         */
        window.showLogin = function() {
            window.showScreen('loginScreen');
        };

        /**
         * MÃ¼ÅŸteri sorgu ekranÄ±nÄ± gÃ¶sterir ve baÅŸlatÄ±r.
         */
        window.showCustomerSearch = function() {
            window.showScreen('customerScreen');
            document.getElementById('plateSearch').value = ''; // Arama alanÄ±nÄ± temizle
            document.getElementById('carResults').innerHTML = '<p style="text-align: center; color: #777;">Plaka numarasÄ±nÄ± girerek araÃ§ durumunu sorgulayabilirsiniz.</p>';
            window.selectedRating = 0; // Anketi sÄ±fÄ±rla
            document.getElementById('feedbackText').value = '';
            document.querySelectorAll('#ratingStars .star').forEach(star => star.classList.remove('active'));
            window.updateUI(); // Bu ekrana geÃ§iÅŸte butonlarÄ±n doÄŸru olduÄŸundan emin ol
        };

        /**
         * Ã‡alÄ±ÅŸan panelini gÃ¶sterir ve mevcut araÃ§ listesini render eder.
         */
        window.showEmployeePanel = function() {
            // Firebase Auth kullanÄ±cÄ±sÄ± yoksa veya rolÃ¼ uygun deÄŸilse eriÅŸimi engelle
            if (!window.firebaseAuth.currentUser || !window.currentUser || (window.currentUser.role !== 'user' && window.currentUser.role !== 'admin')) {
                window.showNotification('Bu alana eriÅŸim izniniz yok!', 'error');
                window.showLogin();
                return;
            }
            window.showScreen('employeeScreen');
            window.cancelCarEdit(); // Formu her zaman temiz bir ÅŸekilde gÃ¶ster
            window.updateUI(); // Bu ekrana geÃ§iÅŸte butonlarÄ±n doÄŸru olduÄŸundan emin ol
            // Veriler Firebase dinleyicisi tarafÄ±ndan otomatik olarak render edilecektir.
        };

        /**
         * Admin panelini (kullanÄ±cÄ± yÃ¶netimi) gÃ¶sterir ve mevcut kullanÄ±cÄ± listesini render eder.
         */
        window.showAdminPanel = function() {
            // Firebase Auth kullanÄ±cÄ±sÄ± yoksa veya admin deÄŸilse eriÅŸimi engelle
            if (!window.firebaseAuth.currentUser || !window.currentUser || window.currentUser.role !== 'admin') {
                window.showNotification('Bu alana eriÅŸim izniniz yok!', 'error');
                window.showLogin();
                return;
            }
            window.showScreen('adminScreen');
            renderUserList(); // Admin paneline kullanÄ±cÄ±larÄ± render et
            populateUserSelectionForPasswordReset(); // KullanÄ±cÄ± seÃ§me dropdown'Ä±nÄ± doldur
            
            // FormlarÄ± temizle
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newUserRole').value = 'user';
            document.getElementById('oldPassword').value = '';
            document.getElementById('newAuthPassword').value = '';
            document.getElementById('confirmNewAuthPassword').value = '';
            document.getElementById('selectUserForPasswordReset').value = '';
            document.getElementById('selectedUserNewPassword').value = '';
            document.getElementById('confirmSelectedUserNewPassword').value = '';

            // TÃ¼m hata mesajlarÄ±nÄ± ve invalid stillerini temizle
            document.querySelectorAll('#adminScreen .error-message').forEach(el => el.textContent = '');
            document.querySelectorAll('#adminScreen input, #adminScreen select').forEach(el => el.classList.remove('is-invalid'));

            window.updateUI(); // Bu ekrana geÃ§iÅŸte butonlarÄ±n doÄŸru olduÄŸundan emin ol
        };

        /**
         * Raporlar ekranÄ±nÄ± gÃ¶sterir ve raporlarÄ± oluÅŸturur.
         */
        window.showReports = function() {
            // Firebase Auth kullanÄ±cÄ±sÄ± yoksa veya admin deÄŸilse eriÅŸimi engelle
            if (!window.firebaseAuth.currentUser || !window.currentUser || window.currentUser.role !== 'admin') {
                window.showNotification('Bu alana eriÅŸim izniniz yok!', 'error');
                window.showLogin();
                return;
            }
            window.showScreen('reportsScreen');
            renderReports(); // RaporlarÄ± oluÅŸtur ve gÃ¶ster
            window.updateUI(); // Bu ekrana geÃ§iÅŸte butonlarÄ±n doÄŸru olduÄŸundan emin ol
        };

        /**
         * AraÃ§ kartlarÄ±nÄ± belirtilen HTML Ã¶ÄŸesine render eder.
         * @param {string} targetElementId - AraÃ§larÄ±n render edileceÄŸi Ã¶ÄŸenin ID'si.
         * @param {Array<Object>} carsToRender - GÃ¶rÃ¼ntÃ¼lenecek araÃ§ nesneleri dizisi.
         * @param {boolean} allowCarActions - Ã‡alÄ±ÅŸan/admin paneli iÃ§in render ediliyorsa true (aksiyon butonlarÄ± ekler).
         * @param {boolean} showDrawer - Detaylar geniÅŸletilebilir bir Ã§ekmecede gÃ¶sterilmeli mi.
         */
        function renderCars(targetElementId, carsToRender, allowCarActions = false, showDrawer = false) {
            const container = document.getElementById(targetElementId);
            if (!container) {
                console.error(`Hedef Ã¶ÄŸe "${targetElementId}" bulunamadÄ±.`);
                return;
            }
            container.innerHTML = ''; // Ã–nceki sonuÃ§larÄ± temizle

            if (carsToRender.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777;">HiÃ§ araÃ§ bulunamadÄ±.</p>';
                return;
            }

            // `car.entryTime` tarihine gÃ¶re en yeniden en eskiye sÄ±rala
            const sortedCars = [...carsToRender].sort((a, b) => new Date(b.entryTime) - new Date(a.entryTime));

            sortedCars.forEach(car => {
                const entryDate = formatDate(car.entryTime);
                const entryTime = formatTime(car.entryTime);
                const progressWidth = car.currentProgress > 0 ? car.currentProgress : 0;

                // Silme butonu sadece admin iÃ§in gÃ¶sterilsin
                const showDeleteButton = window.currentUser && window.currentUser.role === 'admin';
                const showEditButton = window.currentUser && (window.currentUser.role === 'admin' || window.currentUser.role === 'user');

                // Durumun TÃ¼rkÃ§e metni ve CSS sÄ±nÄ±fÄ± eÅŸleÅŸtirmesi
                const statusMap = {
                    'inQueue': { text: 'SÄ±rada', class: 'inqueue' },
                    'exteriorWash': { text: 'DÄ±ÅŸ YÄ±kamada', class: 'exteriorwash' },
                    'dryingArea': { text: 'Kurulama AlanÄ±nda', class: 'dryingarea' },
                    'parkingArea': { text: 'Park AlanÄ±nda', class: 'parkingarea' },
                    'delivered': { text: 'Teslim Edildi', class: 'delivered' }
                };
                const currentStatusInfo = statusMap[car.status] || { text: capitalizeFirstLetter(car.status), class: car.status };


                const carDetailsHtml = `
                    <div class="car-details">
                        <div class="detail-item">
                            <div class="detail-label">MÃ¼ÅŸteri AdÄ±</div>
                            <div class="detail-value">${car.customer || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Telefon</div>
                            <div class="detail-value">${car.phone || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">AraÃ§ Modeli</div>
                            <div class="detail-value">${car.model || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Hizmet TÃ¼rÃ¼</div>
                            <div class="detail-value">${car.serviceType || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">GiriÅŸ ZamanÄ±</div>
                            <div class="detail-value">${entryDate} ${entryTime}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Tahmini SÃ¼re</div>
                            <div class="detail-value">${car.estimatedTime ? car.estimatedTime + ' dk' : 'N/A'}</div>
                        </div>
                         <div class="detail-item">
                            <div class="detail-label">Fiyat</div>
                            <div class="detail-value">â‚º${car.price ? car.price.toLocaleString('tr-TR') : 'N/A'}</div>
                        </div>
                         <div class="detail-item">
                            <div class="detail-label">Ekleyen</div>
                            <div class="detail-value">${car.addedBy || 'N/A'}</div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressWidth}%;"></div>
                    </div>
                `;

                const carCardHtml = `
                    <div class="car-card">
                        <div class="car-header">
                            <div class="plate-number">${car.plate.toUpperCase()}</div>
                            <div class="status ${currentStatusInfo.class}">${currentStatusInfo.text}</div>
                        </div>
                        ${showDrawer ? `
                        <details>
                            <summary>DetaylarÄ± GÃ¶r <i class="fa-solid fa-angle-right"></i></summary>
                            ${carDetailsHtml}
                        </details>
                        ` : carDetailsHtml}

                        ${allowCarActions && (window.currentUser && (window.currentUser.role === 'admin' || window.currentUser.role === 'user')) ? `
                        <div class="status-controls">
                            <button class="status-btn inqueue ${car.status === 'inQueue' ? 'active' : ''}" onclick="updateCarStatus('${car.id}', 'inQueue')">
                                <i class="fa-solid fa-hourglass-half"></i> SÄ±rada
                            </button>
                            <button class="status-btn exteriorwash ${car.status === 'exteriorWash' ? 'active' : ''}" onclick="updateCarStatus('${car.id}', 'exteriorWash')">
                                <i class="fa-solid fa-water"></i> DÄ±ÅŸ YÄ±kamada
                            </button>
                            <button class="status-btn dryingarea ${car.status === 'dryingArea' ? 'active' : ''}" onclick="updateCarStatus('${car.id}', 'dryingArea')">
                                <i class="fa-solid fa-wind"></i> Kurulama AlanÄ±nda
                            </button>
                            <button class="status-btn parkingarea ${car.status === 'parkingArea' ? 'active' : ''}" onclick="updateCarStatus('${car.id}', 'parkingArea')">
                                <i class="fa-solid fa-parking"></i> Park AlanÄ±nda
                            </button>
                            <button class="status-btn delivered ${car.status === 'delivered' ? 'active' : ''}" onclick="updateCarStatus('${car.id}', 'delivered')">
                                <i class="fa-solid fa-truck"></i> Teslim Edildi
                            </button>
                        </div>
                        <div class="button-group" style="justify-content: center; margin-top: 10px;">
                           ${showEditButton ? `<button class="btn btn-secondary" onclick="editCar('${car.id}')"><i class="fa-solid fa-edit"></i> DÃ¼zenle</button>` : ''}
                           ${showDeleteButton ? `<button class="btn btn-danger" onclick="deleteCar('${car.id}')"><i class="fa-solid fa-trash-alt"></i> Sil</button>` : ''}
                        </div>
                        ` : ''}
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', carCardHtml);
            });
        }

        /**
         * KullanÄ±cÄ±nÄ±n girdiÄŸi plaka numarasÄ±na gÃ¶re araÃ§larÄ± filtreler.
         */
        window.searchCar = function() {
            const plateSearchInput = document.getElementById('plateSearch');
            const searchTerm = plateSearchInput.value.trim().toUpperCase();
            
            if (searchTerm.length < 2) {
                document.getElementById('carResults').innerHTML = '<p style="text-align: center; color: #777;">Plaka numarasÄ±nÄ± girerek araÃ§ durumunu sorgulayabilirsiniz.</p>';
                return;
            }

            const filteredCars = window.cars.filter(car => 
                car.plate.toUpperCase().includes(searchTerm)
            );
            renderCars('carResults', filteredCars, false, false); 
        };

        /**
         * Memnuniyet anketi iÃ§in seÃ§ilen puanÄ± ayarlar ve yÄ±ldÄ±zlarÄ±n gÃ¶rselini gÃ¼nceller.
         * @param {number} rating - SeÃ§ilen puan (1-5).
         */
        window.setRating = function(rating) {
            window.selectedRating = rating;
            const stars = document.querySelectorAll('#ratingStars .star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        };

        /**
         * MÃ¼ÅŸteri geri bildirimini (puan ve yorum) Firestore'a gÃ¶nderir.
         */
        window.submitFeedback = async function() {
            if (!window.firestoreDb || !window.feedbackCollectionRef) {
                window.showNotification("VeritabanÄ± baÄŸlantÄ±sÄ± henÃ¼z hazÄ±r deÄŸil.", "error");
                return;
            }
            const feedbackText = document.getElementById('feedbackText').value.trim();
            
            if (window.selectedRating === 0 && !feedbackText) {
                window.showNotification('LÃ¼tfen bir puan verin veya yorum yazÄ±n!', 'error');
                return;
            }

            toggleButtonState('submitFeedbackBtn', true); // Butonu devre dÄ±ÅŸÄ± bÄ±rak
            try {
                // Anonim kullanÄ±cÄ± da geri bildirim gÃ¶nderebilir.
                // GÃ¼venlik kurallarÄ±nÄ±zda (Firestore Rules) anonim kullanÄ±cÄ±larÄ±n yazma izni olmasÄ± gerekir.
                await addDoc(window.feedbackCollectionRef, {
                    rating: window.selectedRating,
                    comment: feedbackText,
                    timestamp: new Date().toISOString(),
                    plate: document.getElementById('plateSearch').value.trim().toUpperCase() || 'N/A',
                    userId: window.currentUserId, // Geri bildirimi gÃ¶nderen kullanÄ±cÄ±nÄ±n UID'si
                    userName: window.currentUser ? window.currentUser.username : 'Anonim'
                });
                window.showNotification('Geri bildiriminiz baÅŸarÄ±yla gÃ¶nderildi!', 'success');
                
                // Anketi sÄ±fÄ±rla
                window.selectedRating = 0;
                document.getElementById('feedbackText').value = '';
                document.querySelectorAll('#ratingStars .star').forEach(star => star.classList.remove('active'));
                
            } catch (e) {
                console.error("Geri bildirim gÃ¶nderilirken hata oluÅŸtu:", e);
                window.showNotification("Geri bildirim gÃ¶nderilirken hata oluÅŸtu!", "error");
            } finally {
                toggleButtonState('submitFeedbackBtn', false); // Butonu tekrar etkinleÅŸtir
            }
        };

        /**
         * Sisteme yeni bir kullanÄ±cÄ± ekler (Sadece Admin).
         */
        window.addUser = async function() {
            if (!window.currentUser || window.currentUser.role !== 'admin') {
                window.showNotification('Sadece adminler kullanÄ±cÄ± ekleyebilir!', 'error');
                return;
            }

            const newUsernameInput = document.getElementById('newUsername');
            const newPasswordInput = document.getElementById('newPassword');
            const newUserRoleSelect = document.getElementById('newUserRole');

            const fields = [
                { id: 'newUsername', name: 'KullanÄ±cÄ± adÄ±', required: true },
                { id: 'newPassword', name: 'Åifre', required: true, type: 'password' }
            ];
            if (!validateForm(fields)) {
                window.showNotification('LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun!', 'error');
                return;
            }

            // KullanÄ±cÄ± adÄ±nÄ± e-posta adresine dÃ¶nÃ¼ÅŸtÃ¼r (Firebase Auth iÃ§in benzersiz olmalÄ±)
            const newUserEmail = `${newUsernameInput.value.trim().toLowerCase()}@${APP_ID_FOR_FIRESTORE_PATHS}.com`;

            // Firebase Auth'ta zaten bÃ¶yle bir e-posta var mÄ± kontrol et
            try {
                await fetchSignInMethodsForEmail(window.firebaseAuth, newUserEmail);
                // EÄŸer buraya gelirse, e-posta zaten kullanÄ±lÄ±yor demektir.
                window.showNotification('Bu e-posta adresi zaten kullanÄ±lÄ±yor. BaÅŸka bir kullanÄ±cÄ± adÄ± deneyin.', 'error');
                newUsernameInput.classList.add('is-invalid');
                document.getElementById('errorNewUsername').textContent = 'Bu e-posta adresi zaten kullanÄ±lÄ±yor.';
                return;
            } catch (error) {
                if (error.code !== 'auth/user-not-found') { // auth/user-not-found ise devam edebiliriz
                    console.error("E-posta kontrolÃ¼ sÄ±rasÄ±nda hata:", error);
                    window.showNotification("KullanÄ±cÄ± eklenirken hata oluÅŸtu!", "error");
                    return;
                }
            }
            
            toggleButtonState('addUserBtn', true); // Butonu devre dÄ±ÅŸÄ± bÄ±rak
            window.showNotification('KullanÄ±cÄ± ekleniyor...', 'info');
            try {
                // Firebase Auth'ta kullanÄ±cÄ± oluÅŸtur
                const userCredential = await createUserWithEmailAndPassword(window.firebaseAuth, newUserEmail, newPasswordInput.value.trim());
                const newUserUid = userCredential.user.uid;

                // Firestore'da kullanÄ±cÄ± rolÃ¼nÃ¼ kaydet
                await setDoc(doc(window.userRolesCollectionRef, newUserUid), { // doc().set() kullanarak UID'yi belge ID'si yap
                    username: newUsernameInput.value.trim(), 
                    email: newUserEmail, 
                    role: newUserRoleSelect.value 
                });
                console.log(`Firestore'a kullanÄ±cÄ± rolÃ¼ kaydedildi: UID=${newUserUid}, Rol=${newUserRoleSelect.value}`);


                window.showNotification(`'${newUsernameInput.value.trim()}' kullanÄ±cÄ±sÄ± (${newUserRoleSelect.value === 'admin' ? 'Admin' : 'Ã‡alÄ±ÅŸan'}) baÅŸarÄ±yla eklendi!`, 'success');
                
                newUsernameInput.value = '';
                newPasswordInput.value = '';
                newUserRoleSelect.value = 'user';
                // Firestore listener otomatik olarak userList'i ve populateUserSelectionForPasswordReset'i gÃ¼ncelleyecektir.
            } catch (e) {
                console.error("KullanÄ±cÄ± eklenirken Firebase Auth hatasÄ±:", e);
                let errorMessage = "KullanÄ±cÄ± eklenirken hata oluÅŸtu!";
                if (e.code === 'auth/email-already-in-use') {
                    errorMessage = 'Bu e-posta adresi zaten kullanÄ±lÄ±yor. BaÅŸka bir kullanÄ±cÄ± adÄ± deneyin.';
                    newUsernameInput.classList.add('is-invalid');
                    document.getElementById('errorNewUsername').textContent = errorMessage;
                } else if (e.code === 'auth/weak-password') {
                    errorMessage = 'Åifre Ã§ok zayÄ±f. En az 6 karakter olmalÄ±dÄ±r.';
                    newPasswordInput.classList.add('is-invalid');
                    document.getElementById('errorNewPassword').textContent = errorMessage;
                }
                window.showNotification(errorMessage, "error");
            } finally {
                toggleButtonState('addUserBtn', false); // Butonu tekrar etkinleÅŸtir
            }
        };

        /**
         * Mevcut kullanÄ±cÄ±larÄ±n listesini render eder (Sadece Admin).
         * Bu liste Firestore'daki user_roles koleksiyonundan Ã§ekilir.
         */
        function renderUserList() {
            const userListContainer = document.getElementById('userList');
            if (!userListContainer) return;

            userListContainer.innerHTML = ''; // Mevcut listeyi temizle

            if (window.users.length === 0) {
                userListContainer.innerHTML = '<p style="text-align: center; color: #777;">Sistemde kayÄ±tlÄ± kullanÄ±cÄ± bulunmuyor.</p>';
                return;
            }

            const userCardsHtml = window.users.map(user => `
                <div class="car-card" style="margin-bottom: 15px; padding: 15px;">
                    <div class="car-header" style="margin-bottom: 5px;">
                        <span class="plate-number" style="font-size: 20px;">${user.username}</span>
                        <span class="status ${user.role === 'admin' ? 'ready' : 'delivered'}" style="font-size: 11px;">
                            ${user.role === 'admin' ? 'Admin' : 'Ã‡alÄ±ÅŸan'}
                        </span>
                    </div>
                    <div class="detail-item" style="padding: 8px;">
                        <div class="detail-label">E-posta</div>
                        <div class="detail-value">${user.email}</div>
                    </div>
                </div>
            `).join('');
            userListContainer.innerHTML = userCardsHtml;
        }

        /**
         * Åifre deÄŸiÅŸtirmek iÃ§in kullanÄ±cÄ± seÃ§imi dropdown'Ä±nÄ± doldurur.
         * Bu liste Firestore'daki user_roles koleksiyonundan Ã§ekilir.
         */
        function populateUserSelectionForPasswordReset() {
            const selectElement = document.getElementById('selectUserForPasswordReset');
            if (!selectElement) return;

            selectElement.innerHTML = '<option value="">KullanÄ±cÄ± SeÃ§in</option>'; // VarsayÄ±lan seÃ§eneÄŸi ekle ve temizle

            window.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.uid; // UID'yi deÄŸer olarak kullan
                option.textContent = `${user.username} (${user.role === 'admin' ? 'Admin' : 'Ã‡alÄ±ÅŸan'})`;
                selectElement.appendChild(option);
            });
        }

        /**
         * GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±nÄ±n kendi ÅŸifresini deÄŸiÅŸtirir (Firebase Auth UpdatePassword).
         */
        window.changeMyOwnPassword = async function() {
            if (!window.firebaseAuth.currentUser || !window.currentUser) {
                window.showNotification('Åifre deÄŸiÅŸtirmek iÃ§in giriÅŸ yapmalÄ±sÄ±nÄ±z!', 'error');
                return;
            }

            const oldPasswordInput = document.getElementById('oldPassword');
            const newAuthPasswordInput = document.getElementById('newAuthPassword');
            const confirmNewAuthPasswordInput = document.getElementById('confirmNewAuthPassword');

            const fields = [
                { id: 'oldPassword', name: 'Eski Åifre', required: true },
                { id: 'newAuthPassword', name: 'Yeni Åifre', required: true, type: 'password' },
                { id: 'confirmNewAuthPassword', name: 'Yeni Åifre Tekrar', required: true, type: 'confirmPassword', matchId: 'newAuthPassword' }
            ];

            if (!validateForm(fields)) {
                window.showNotification('LÃ¼tfen tÃ¼m ÅŸifre alanlarÄ±nÄ± doÄŸru doldurun!', 'error');
                return;
            }

            // Firebase Auth ÅŸifre deÄŸiÅŸtirme iÅŸlemi Ã¶ncesi kullanÄ±cÄ±nÄ±n kimliÄŸini yeniden doÄŸrulamak iyi bir gÃ¼venlik uygulamasÄ±dÄ±r.
            // (e.g., EmailAuthProvider.credential ve reauthenticateWithCredential)
            // Bu demo basitlik iÃ§in atlanmÄ±ÅŸtÄ±r, ancak gerÃ§ek bir uygulamada Ã¶nemlidir.

            if (newAuthPasswordInput.value === oldPasswordInput.value) {
                window.showNotification('Yeni ÅŸifre eski ÅŸifre ile aynÄ± olamaz!', 'error');
                newAuthPasswordInput.classList.add('is-invalid');
                document.getElementById('errorNewAuthPassword').textContent = 'Yeni ÅŸifre eski ÅŸifre ile aynÄ± olamaz.';
                return;
            }

            toggleButtonState('changeMyOwnPasswordBtn', true);
            window.showNotification('Åifre gÃ¼ncelleniyor...', 'info');
            try {
                await updatePassword(window.firebaseAuth.currentUser, newAuthPasswordInput.value);
                window.showNotification('Åifreniz baÅŸarÄ±yla deÄŸiÅŸtirildi!', 'success');
                
                oldPasswordInput.value = '';
                newAuthPasswordInput.value = '';
                confirmNewAuthPasswordInput.value = '';
                // Firestore listener (userRolesUnsubscribe) aracÄ±lÄ±ÄŸÄ±yla `window.users` otomatik olarak gÃ¼ncellenir.
                // (Ancak Firestore'daki user_roles belgesine ÅŸifre saklamÄ±yoruz, sadece demo LOCAL_DEMO_USERS'Ä± temsil eder).
            } catch (e) {
                console.error("Kendi ÅŸifresi deÄŸiÅŸtirilirken hata oluÅŸtu:", e);
                let errorMessage = "Åifre deÄŸiÅŸtirilirken hata oluÅŸtu!";
                if (e.code === 'auth/requires-recent-login') {
                    errorMessage = 'Bu iÅŸlem iÃ§in tekrar giriÅŸ yapmanÄ±z gerekiyor. LÃ¼tfen Ã§Ä±kÄ±ÅŸ yapÄ±p tekrar giriÅŸ yapÄ±n.';
                } else if (e.code === 'auth/weak-password') {
                    errorMessage = 'Åifre Ã§ok zayÄ±f. Daha gÃ¼Ã§lÃ¼ bir ÅŸifre deneyin.';
                }
                window.showNotification(errorMessage, "error");
            } finally {
                toggleButtonState('changeMyOwnPasswordBtn', false);
            }
        };

        /**
         * SeÃ§ilen kullanÄ±cÄ±nÄ±n ÅŸifresini admin olarak sÄ±fÄ±rlar/deÄŸiÅŸtirir.
         * NOT: Bu iÅŸlem, istemci tarafÄ± Firebase Auth SDK ile doÄŸrudan yapÄ±lamaz.
         * Sunucu tarafÄ± (Firebase Admin SDK veya Cloud Function) gerektirir.
         * Bu demo sadece UI'Ä± gÃ¶sterir ve konsola hata basar, gerÃ§ek ÅŸifre sÄ±fÄ±rlama yapmaz.
         */
        window.resetSelectedUserPassword = async function() {
            if (!window.currentUser || window.currentUser.role !== 'admin') {
                window.showNotification('Bu iÅŸlemi yapmaya yetkiniz yok!', 'error');
                return;
            }

            const selectUserForPasswordReset = document.getElementById('selectUserForPasswordReset');
            const selectedUserNewPassword = document.getElementById('selectedUserNewPassword');
            const confirmSelectedUserNewPassword = document.getElementById('confirmSelectedUserNewPassword');

            const fields = [
                { id: 'selectUserForPasswordReset', name: 'KullanÄ±cÄ±', required: true },
                { id: 'selectedUserNewPassword', name: 'Yeni Åifre', required: true, type: 'password' },
                { id: 'confirmSelectedUserNewPassword', name: 'Yeni Åifre Tekrar', required: true, type: 'confirmPassword', matchId: 'selectedUserNewPassword' }
            ];

            if (!validateForm(fields)) {
                window.showNotification('LÃ¼tfen tÃ¼m alanlarÄ± doÄŸru doldurun!', 'error');
                return;
            }

            const targetUid = selectUserForPasswordReset.value; 
            const newPassword = selectedUserNewPassword.value;

            const targetUserInRoles = window.users.find(u => u.uid === targetUid); 

            if (!targetUserInRoles) {
                window.showNotification('SeÃ§ilen kullanÄ±cÄ± bulunamadÄ±!', 'error');
                return;
            }
            // Åifre aynÄ± olamaz kontrolÃ¼ (sadece demo kullanÄ±cÄ±larÄ± iÃ§in)
            // Normalde Firebase Admin SDK ÅŸifre kontrolÃ¼ yapmaz, direkt gÃ¼nceller.
            const targetDemoUser = LOCAL_DEMO_USERS.find(u => u.email === targetUserInRoles.email);
            if (targetDemoUser && targetDemoUser.password === newPassword) {
                window.showNotification('Yeni ÅŸifre eski ÅŸifre ile aynÄ± olamaz!', 'error');
                selectedUserNewPassword.classList.add('is-invalid');
                document.getElementById('errorSelectedUserNewPassword').textContent = 'Yeni ÅŸifre eski ÅŸifre ile aynÄ± olamaz.';
                return;
            }

            toggleButtonState('resetSelectedUserPasswordBtn', true);
            window.showNotification(`'${targetUserInRoles.username}' kullanÄ±cÄ±sÄ±nÄ±n ÅŸifresi gÃ¼ncelleniyor... (DEMO)`, 'info');
            
            try {
                // *** GERÃ‡EK UYGULAMADA BURADA SUNUCU TARAFI BÄ°R Ä°ÅLEM OLMALIDIR ***
                // Firebase Admin SDK (Node.js/Python vb. ile) kullanÄ±larak:
                // admin.auth().updateUser(targetUid, { password: newPassword });
                // VEYA Firebase Cloud Function Ã§aÄŸrÄ±sÄ± yapÄ±lmalÄ±dÄ±r.
                console.error("Admin olarak baÅŸka bir kullanÄ±cÄ±nÄ±n ÅŸifresini doÄŸrudan istemci tarafÄ±ndan deÄŸiÅŸtirmek gÃ¼venlik sebebiyle mÃ¼mkÃ¼n deÄŸildir. Sunucu taraflÄ± Admin SDK kullanmanÄ±z gerekir.");
                window.showNotification("BaÅŸka bir kullanÄ±cÄ±nÄ±n ÅŸifresi demo sÃ¼rÃ¼mÃ¼nde deÄŸiÅŸtirilemez!", "error");
                
                // Demo kullanÄ±cÄ± dizisini gÃ¼ncelle (sadece UI temsili iÃ§in)
                if (targetDemoUser) {
                    targetDemoUser.password = newPassword;
                }

                selectUserForPasswordReset.value = '';
                selectedUserNewPassword.value = '';
                confirmSelectedUserNewPassword.value = '';
                // Firestore listener otomatik olarak `window.users`'Ä± gÃ¼ncelleyecektir,
                // ancak bu durumda Firestore'daki rol belgesine ÅŸifre yazmadÄ±ÄŸÄ±mÄ±z iÃ§in
                // bu gÃ¼ncelleme gÃ¶rsel olarak yansÄ±maz.

            } catch (e) {
                console.error("Åifre sÄ±fÄ±rlanÄ±rken hata oluÅŸtu:", e);
                window.showNotification("Åifre sÄ±fÄ±rlanÄ±rken hata oluÅŸtu!", "error");
            } finally {
                toggleButtonState('resetSelectedUserPasswordBtn', false);
            }
        };

        /**
         * AraÃ§ ekleme veya dÃ¼zenleme iÅŸlemini yÃ¶netir.
         * Formdaki `currentEditingCarId` deÄŸerine gÃ¶re ekleme veya gÃ¼ncelleme yapar.
         */
        window.handleAddOrUpdateCar = async function() {
            if (!window.firestoreDb || !window.carsCollectionRef || !window.firebaseAuth.currentUser) {
                window.showNotification("VeritabanÄ± baÄŸlantÄ±sÄ± veya kullanÄ±cÄ± oturumu hazÄ±r deÄŸil.", "error");
                return;
            }
            if (!window.currentUser || (window.currentUser.role !== 'user' && window.currentUser.role !== 'admin')) {
                window.showNotification('Bu iÅŸlemi yapmaya yetkiniz yok!', 'error');
                return;
            }

            const currentEditingCarId = document.getElementById('currentEditingCarId');
            const newPlateInput = document.getElementById('newPlate');
            const customerNameInput = document.getElementById('customerName');
            const customerPhoneInput = document.getElementById('customerPhone');
            const carModelInput = document.getElementById('carModel');
            const serviceTypeInput = document.getElementById('serviceType');
            const carStatusInput = document.getElementById('carStatus');
            const estimatedTimeInput = document.getElementById('estimatedTime');
            const carPriceInput = document.getElementById('carPrice');

            const fields = [
                { id: 'newPlate', name: 'Plaka', required: true },
                { id: 'serviceType', name: 'Hizmet TÃ¼rÃ¼', required: true },
                { id: 'carStatus', name: 'Durum', required: true },
                { id: 'customerName', name: 'MÃ¼ÅŸteri AdÄ±', required: false },
                { id: 'customerPhone', name: 'Telefon', required: false, type: 'phone' },
                { id: 'carModel', name: 'AraÃ§ Modeli', required: false },
                { id: 'estimatedTime', name: 'Tahmini SÃ¼re', required: false, type: 'number', min: 1 },
                { id: 'carPrice', name: 'Fiyat', required: false, type: 'number', min: 0 }
            ];

            if (!validateForm(fields)) {
                window.showNotification('LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun ve diÄŸerlerini doÄŸru formatta girin!', 'error');
                return;
            }

            const carData = {
                plate: newPlateInput.value.trim().toUpperCase(),
                customer: customerNameInput.value.trim() || null, // BoÅŸsa null kaydet
                phone: customerPhoneInput.value.trim() || null, // BoÅŸsa null kaydet
                model: carModelInput.value.trim() || null, // BoÅŸsa null kaydet
                serviceType: serviceTypeInput.value,
                status: carStatusInput.value,
                addedBy: window.currentUser ? window.currentUser.username : 'Unknown',
                estimatedTime: estimatedTimeInput.value ? parseInt(estimatedTimeInput.value) : null,
                currentProgress: (carStatusInput.value === 'delivered' || carStatusInput.value === 'parkingArea') ? 100 : 0, // Ä°lerleme durumunu gÃ¼ncelle
                price: carPriceInput.value ? parseFloat(carPriceInput.value) : null
            };

            toggleButtonState('submitCarBtn', true); // Butonu devre dÄ±ÅŸÄ± bÄ±rak
            toggleButtonState('cancelCarEditBtn', true);
            window.showNotification('Ä°ÅŸlem yapÄ±lÄ±yor...', 'info');
            try {
                if (currentEditingCarId.value) { // currentEditingCarId.value'yu kontrol et
                    // DÃ¼zenleme iÅŸlemi
                    const carRef = doc(window.firestoreDb, window.carsCollectionRef.path, currentEditingCarId.value);
                    await updateDoc(carRef, carData);
                    window.showNotification(`'${carData.plate}' plakalÄ± araÃ§ baÅŸarÄ±yla gÃ¼ncellendi!`, 'success');
                } else {
                    // Ekleme iÅŸlemi
                    // PlakanÄ±n zaten var olup olmadÄ±ÄŸÄ±nÄ± Firestore'da kontrol et
                    const q = query(window.carsCollectionRef, where("plate", "==", carData.plate));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        window.showNotification('Bu plaka numarasÄ± zaten kayÄ±tlÄ±!', 'error');
                        newPlateInput.classList.add('is-invalid');
                        document.getElementById('errorNewPlate').textContent = 'Bu plaka numarasÄ± zaten kayÄ±tlÄ±.';
                        return; // Ä°ÅŸlemi durdur
                    }
                    carData.entryTime = new Date().toISOString(); // Yeni araÃ§ iÃ§in giriÅŸ zamanÄ±
                    await addDoc(window.carsCollectionRef, carData);
                    window.showNotification(`'${carData.plate}' plakalÄ± araÃ§ baÅŸarÄ±yla eklendi!`, 'success');
                }
                window.cancelCarEdit(); // Formu temizle ve ekleme moduna dÃ¶n
            } catch (e) {
                console.error("AraÃ§ iÅŸlemi sÄ±rasÄ±nda hata oluÅŸtu:", e);
                window.showNotification("AraÃ§ iÅŸlemi sÄ±rasÄ±nda hata oluÅŸtu!", "error");
            } finally {
                toggleButtonState('submitCarBtn', false); // Butonu tekrar etkinleÅŸtir
                toggleButtonState('cancelCarEditBtn', false);
            }
        };

        /**
         * Bir aracÄ± dÃ¼zenlemek iÃ§in formu doldurur.
         * @param {string} carId - DÃ¼zenlenecek aracÄ±n Firestore Belge ID'si.
         */
        window.editCar = function(carId) {
            const car = window.cars.find(c => c.id === carId);
            if (!car) {
                window.showNotification('DÃ¼zenlenecek araÃ§ bulunamadÄ±!', 'error');
                return;
            }

            document.getElementById('currentEditingCarId').value = car.id;
            document.getElementById('carFormTitle').innerHTML = '<i class="fa-solid fa-edit"></i> AraÃ§ DÃ¼zenle';
            document.getElementById('submitCarBtn').innerHTML = '<i class="fa-solid fa-save"></i> AracÄ± GÃ¼ncelle';
            document.getElementById('cancelCarEditBtn').style.display = 'inline-flex'; // Butonu gÃ¶ster

            document.getElementById('newPlate').value = car.plate;
            document.getElementById('customerName').value = car.customer || '';
            document.getElementById('customerPhone').value = car.phone || '';
            document.getElementById('carModel').value = car.model || '';
            document.getElementById('serviceType').value = car.serviceType;
            document.getElementById('carStatus').value = car.status;
            document.getElementById('estimatedTime').value = car.estimatedTime || '';
            document.getElementById('carPrice').value = car.price || '';

            // Form validasyon hatalarÄ±nÄ± temizle
            document.querySelectorAll('#employeeScreen .error-message').forEach(el => el.textContent = '');
            document.querySelectorAll('#employeeScreen input, #employeeScreen select').forEach(el => el.classList.remove('is-invalid'));

            // SayfanÄ±n en Ã¼stÃ¼ne kaydÄ±r
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        /**
         * AraÃ§ ekleme/dÃ¼zenleme formunu temizler ve ekleme moduna dÃ¶ner.
         */
        window.cancelCarEdit = function() {
            document.getElementById('currentEditingCarId').value = '';
            document.getElementById('carFormTitle').innerHTML = '<i class="fa-solid fa-car-plus"></i> Yeni AraÃ§ Ekle';
            document.getElementById('submitCarBtn').innerHTML = '<i class="fa-solid fa-car-rear"></i> AraÃ§ Ekle';
            document.getElementById('cancelCarEditBtn').style.display = 'none';

            document.getElementById('newPlate').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('carModel').value = '';
            document.getElementById('serviceType').value = 'DÄ±ÅŸ YÄ±kama';
            document.getElementById('carStatus').value = 'inQueue'; // VarsayÄ±lan baÅŸlangÄ±Ã§ durumu
            document.getElementById('estimatedTime').value = '';
            document.getElementById('carPrice').value = '';

            // Form validasyon hatalarÄ±nÄ± temizle
            document.querySelectorAll('#employeeScreen .error-message').forEach(el => el.textContent = '');
            document.querySelectorAll('#employeeScreen input, #employeeScreen select').forEach(el => el.classList.remove('is-invalid'));
        };

        /**
         * Belirli bir aracÄ±n durumunu gÃ¼nceller.
         * @param {string} carId - GÃ¼ncellenecek aracÄ±n Firestore Belge ID'si.
         * @param {string} newStatus - Yeni durum (inQueue, exteriorWash, dryingArea, parkingArea, delivered).
         */
        window.updateCarStatus = async function(carId, newStatus) {
            if (!window.firestoreDb || !window.carsCollectionRef || !window.firebaseAuth.currentUser) {
                window.showNotification("VeritabanÄ± baÄŸlantÄ±sÄ± veya kullanÄ±cÄ± oturumu hazÄ±r deÄŸil.", "error");
                return;
            }
            if (!window.currentUser || (window.currentUser.role !== 'user' && window.currentUser.role !== 'admin')) {
                window.showNotification('Durum gÃ¼ncelleme yetkiniz yok!', 'error');
                return;
            }

            const carRef = doc(window.firestoreDb, window.carsCollectionRef.path, carId);
            const carData = window.cars.find(car => car.id === carId); 

            if (!carData) {
                window.showNotification('GÃ¼ncellenecek araÃ§ bulunamadÄ±!', 'error');
                return;
            }

            // ButonlarÄ± ve ilgili UI'larÄ± devre dÄ±ÅŸÄ± bÄ±rak
            document.querySelectorAll(`.status-btn[onclick*="updateCarStatus('${carId}'"]`).forEach(btn => btn.disabled = true);
            window.showNotification('Durum gÃ¼ncelleniyor...', 'info');

            try {
                await updateDoc(carRef, {
                    status: newStatus,
                    // Duruma gÃ¶re ilerleme ayarÄ± (Ã¶rn: Teslim edildi %100, diÄŸerleri 0)
                    currentProgress: (newStatus === 'delivered' || newStatus === 'parkingArea') ? 100 : 0, 
                });
                // TÃ¼rkÃ§e karÅŸÄ±lÄ±ÄŸÄ±nÄ± almak iÃ§in statusMap kullan
                const statusMapTurkish = {
                    'inQueue': 'SÄ±rada',
                    'exteriorWash': 'DÄ±ÅŸ YÄ±kamada',
                    'dryingArea': 'Kurulama AlanÄ±nda',
                    'parkingArea': 'Park AlanÄ±nda',
                    'delivered': 'Teslim Edildi'
                };
                const displayStatus = statusMapTurkish[newStatus] || capitalizeFirstLetter(newStatus);

                window.showNotification(`'${carData.plate}' plakalÄ± aracÄ±n durumu '${displayStatus}' olarak gÃ¼ncellendi!`, 'success');
                // Firestore listener otomatik olarak UI'yÄ± gÃ¼ncelleyecektir.
            } catch (e) {
                console.error("AraÃ§ durumu gÃ¼ncellenirken hata oluÅŸtu:", e);
                window.showNotification("AraÃ§ durumu gÃ¼ncellenirken hata oluÅŸtu!", "error");
            } finally {
                // TÃ¼m ilgili butonlarÄ± tekrar etkinleÅŸtir
                document.querySelectorAll(`.status-btn[onclick*="updateCarStatus('${carId}'"]`).forEach(btn => btn.disabled = false);
            }
        };

        /**
         * Sistemi bir aracÄ± siler (Sadece Admin).
         * @param {string} carId - Silinecek aracÄ±n Firestore Belge ID'si.
         */
        window.deleteCar = async function(carId) {
            if (!window.firestoreDb || !window.carsCollectionRef || !window.firebaseAuth.currentUser) {
                window.showNotification("VeritabanÄ± baÄŸlantÄ±sÄ± veya kullanÄ±cÄ± oturumu hazÄ±r deÄŸil.", "error");
                return;
            }
            if (!window.currentUser || window.currentUser.role !== 'admin') {
                window.showNotification('Sadece adminler araÃ§ silebilir!', 'error');
                return;
            }

            // NOT: window.confirm yerine Ã¶zel bir modal kullanÄ±lmasÄ± tavsiye edilir.
            const userConfirmed = confirm('Bu aracÄ± silmek istediÄŸinizden emin misiniz?'); 
            if (!userConfirmed) return;

            window.showNotification('AraÃ§ siliniyor...', 'info');

            try {
                const carRef = doc(window.firestoreDb, window.carsCollectionRef.path, carId);
                await deleteDoc(carRef);
                window.showNotification('AraÃ§ baÅŸarÄ±yla silindi!', 'success');
                // Firestore listener otomatik olarak UI'yÄ± gÃ¼ncelleyecektir.
            } catch (e) {
                console.error("AraÃ§ silinirken hata oluÅŸtu:", e);
                window.showNotification("AraÃ§ silinirken hata oluÅŸtu!", "error");
            }
        };

        /**
         * Ã‡alÄ±ÅŸan paneli iÃ§in araÃ§ listesini render eder (aksiyon butonlarÄ± ile).
         */
        function renderEmployeeCarList() {
            renderCars('employeeCarList', window.cars, true, true); // Aksiyon butonlarÄ± var, Ã§ekmece var
        }

        /**
         * GÃ¼nlÃ¼k raporlarÄ± oluÅŸturur ve gÃ¶rÃ¼ntÃ¼ler.
         */
        async function renderReports() {
            if (!window.firestoreDb) {
                window.showNotification("VeritabanÄ± baÄŸlantÄ±sÄ± henÃ¼z hazÄ±r deÄŸil.", "error");
                return;
            }
            const todayIstanbul = new Date().toLocaleDateString('en-CA', { timeZone: 'Europe/Istanbul' }); 

            // Firestore'dan gÃ¼ncel araÃ§larÄ± filtrele (entryTime'a gÃ¶re)
            const carsToday = window.cars.filter(car => 
                new Date(car.entryTime).toLocaleDateString('en-CA', { timeZone: 'Europe/Istanbul' }) === todayIstanbul
            );

            document.getElementById('totalCars').textContent = carsToday.length;
            
            // Yeni durumlarÄ± raporlara yansÄ±t
            document.getElementById('washingCars').textContent = carsToday.filter(car => car.status === 'exteriorWash').length;
            document.getElementById('readyCars').textContent = carsToday.filter(car => car.status === 'dryingArea').length;
            document.getElementById('deliveredCars').textContent = carsToday.filter(car => car.status === 'delivered').length;
            // DiÄŸer durumlarÄ± da gÃ¶stermek isterseniz buraya ekleyebilirsiniz (Ã¶rn: SÄ±rada, Park AlanÄ±nda)


            // Firestore'dan geri bildirimleri filtrele
            const feedbackToday = window.feedback.filter(f => 
                new Date(f.timestamp).toLocaleDateString('en-CA', { timeZone: 'Europe/Istanbul' }) === todayIstanbul
            );
            const totalRating = feedbackToday.reduce((sum, f) => sum + f.rating, 0);
            const avgRating = feedbackToday.length > 0 ? (totalRating / feedbackToday.length).toFixed(1) : '0.0';
            document.getElementById('avgRating').textContent = avgRating;

            const totalRevenue = carsToday
                .filter(car => car.status === 'delivered' && car.price)
                .reduce((sum, car) => sum + car.price, 0);
            document.getElementById('totalRevenue').textContent = `â‚º${totalRevenue.toLocaleString('tr-TR')}`;

            renderCars('detailedCarList', carsToday, false, true); // Aksiyon butonlarÄ± yok, Ã§ekmece var
        }

        /**
         * Basit bir benzersiz ID oluÅŸturur (Firestore kendi ID'lerini kullanacak olsa da bu demo iÃ§in duruyor).
         */
        function generateUniqueId() {
             return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        /**
         * ISO string tarihini 'GG.AA.YYYY' formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
         * @param {string} isoString - ISO tarih string'i.
         * @returns {string} FormatlanmÄ±ÅŸ tarih.
         */
        function formatDate(isoString) {
            const date = new Date(isoString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Ay 0-indekslidir
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        /**
         * ISO string tarihini 'SS:DD' formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
         * @param {string} isoString - ISO tarih string'i.
         * @returns {string} FormatlanmÄ±ÅŸ saat.
         */
        function formatTime(isoString) {
            const date = new Date(isoString);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        /**
         * Bir string'in ilk harfini bÃ¼yÃ¼k yapar.
         * @param {string} string - GiriÅŸ string'i.
         * @returns {string} Ä°lk harfi bÃ¼yÃ¼k olan string.
         */
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        /**
         * GÃ¼nlÃ¼k veri temizliÄŸini ve arÅŸivlemesini yapar.
         * Her yeni gÃ¼n (TR saati) baÅŸladÄ±ÄŸÄ±nda Firestore'daki eski verileri arÅŸivler ve ana koleksiyonlarÄ± temizler.
         */
        async function performDailyCleanup() {
            if (!window.firestoreDb || !window.settingsDocRef || !window.carsCollectionRef || !window.feedbackCollectionRef || !window.historicalCarsCollectionRef || !window.historicalFeedbackCollectionRef) {
                console.warn("Firestore veya ilgili koleksiyon referanslarÄ± hazÄ±r deÄŸil, temizlik yapÄ±lamaz.");
                return;
            }

            const todayIstanbul = new Date().toLocaleDateString('en-CA', { timeZone: 'Europe/Istanbul' }); 

            try {
                // Son temizleme tarihini Firestore'dan oku
                const settingsDoc = await getDoc(window.settingsDocRef);
                const lastCleanupDate = settingsDoc.exists() ? settingsDoc.data().lastCleanupDate : null;

                console.log(`GÃ¼ncel Ä°stanbul Tarihi: ${todayIstanbul}`);
                console.log(`Son Temizleme Tarihi (Firestore'dan): ${lastCleanupDate}`);

                if (!lastCleanupDate || todayIstanbul > lastCleanupDate) {
                    window.showNotification('GÃ¼nlÃ¼k temizlik baÅŸlatÄ±lÄ±yor...', 'info');
                    console.log("Yeni gÃ¼n tespit edildi, gÃ¼nlÃ¼k temizlik ve arÅŸivleme baÅŸlatÄ±lÄ±yor.");

                    // Sadece bugÃ¼nden eski olan araÃ§larÄ± al
                    const oldCarsQuery = query(window.carsCollectionRef, where("entryTime", "<", new Date(todayIstanbul).toISOString()));
                    const carsSnapshot = await getDocs(oldCarsQuery);
                    
                    if (!carsSnapshot.empty) {
                        const carMovePromises = carsSnapshot.docs.map(async (d) => {
                            const carData = d.data();
                            await addDoc(window.historicalCarsCollectionRef, { ...carData, originalId: d.id, archivedAt: new Date().toISOString() }); // ArÅŸive taÅŸÄ±
                            await deleteDoc(doc(window.firestoreDb, window.carsCollectionRef.path, d.id)); // Orijinalini sil
                        });
                        await Promise.all(carMovePromises);
                        console.log(`${carsSnapshot.size} eski araÃ§ kaydÄ± arÅŸivlendi ve silindi.`);
                    } else {
                        console.log("ArÅŸivlenecek eski araÃ§ kaydÄ± bulunamadÄ±.");
                    }

                    // Sadece bugÃ¼nden eski olan geri bildirimleri al
                    const oldFeedbackQuery = query(window.feedbackCollectionRef, where("timestamp", "<", new Date(todayIstanbul).toISOString()));
                    const feedbackSnapshot = await oldFeedbackQuery.get();

                    if (!feedbackSnapshot.empty) {
                        const feedbackMovePromises = feedbackSnapshot.docs.map(async (d) => {
                            const feedbackData = d.data();
                            await addDoc(window.historicalFeedbackCollectionRef, { ...feedbackData, originalId: d.id, archivedAt: new Date().toISOString() }); // ArÅŸive taÅŸÄ±
                            await deleteDoc(doc(window.firestoreDb, window.feedbackCollectionRef.path, d.id)); // Orijinalini sil
                        });
                        await Promise.all(feedbackMovePromises);
                        console.log(`${feedbackSnapshot.size} eski geri bildirim kaydÄ± arÅŸivlendi ve silindi.`);
                    } else {
                        console.log("ArÅŸivlenecek eski geri bildirim kaydÄ± bulunamadÄ±.");
                    }
                    
                    // Son temizleme tarihini Firestore'a kaydet
                    await setDoc(window.settingsDocRef, { lastCleanupDate: todayIstanbul });

                    window.showNotification('GÃ¼nlÃ¼k araÃ§ kayÄ±tlarÄ± ve geri bildirimler temizlendi ve arÅŸivlendi!', 'success');
                    console.log("GÃ¼nlÃ¼k temizlik Firestore Ã¼zerinde tamamlandÄ±.");
                } else {
                    console.log("BugÃ¼n temizlik gerekmiyor.");
                }
            } catch (e) {
                console.error("GÃ¼nlÃ¼k temizlik sÄ±rasÄ±nda hata oluÅŸtu:", e);
                window.showNotification("GÃ¼nlÃ¼k temizlik sÄ±rasÄ±nda hata oluÅŸtu!", "error");
            }
        }

        // Uygulama yÃ¼klendiÄŸinde baÅŸlatma noktasÄ±
        window.onload = function() {
            console.log("Window yÃ¼klendi. Firebase baÅŸlatÄ±lÄ±yor...");
            initializeFirebaseAndAuth(); // Firebase'i baÅŸlat ve kimlik doÄŸrulamayÄ± yÃ¶net
        };
    </script>
</body>
</html>
